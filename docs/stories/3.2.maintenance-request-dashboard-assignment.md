# Story 3.2: Maintenance Request Dashboard

## Status

Done



## Story

**As a** maintenance manager,  
**I want** to view and filter maintenance requests,  
**so that** I can monitor the status and progress of maintenance work.

## Acceptance Criteria

1. Dashboard displays all maintenance requests with filtering options
2. Status updates are tracked and displayed
3. Priority levels are clearly indicated
4. Request details include all problem information and attachments
5. Dashboard provides real-time updates on request status changes

## Tasks / Subtasks

- [x] Create Maintenance Request Dashboard Component (AC: 1, 4)
  - [x] Design responsive dashboard layout with data table
  - [x] Implement filtering by status, priority, machine, and date range
  - [x] Add search functionality for request descriptions
  - [x] Display priority levels with color-coded indicators
  - [x] Add pagination for large request lists
  - [x] Implement real-time updates using React Query
  - [x] Add export functionality for request lists

- [x] Create Request Detail View Component (AC: 4)
  - [x] Design comprehensive request detail modal/page
  - [x] Display all request information (machine, reporter, problem description)
  - [x] Show attached files with preview and download options
  - [x] Display failure code and maintenance type information
  - [x] Add request timeline/history view
  - [x] Implement status change tracking

- [x] Create API Endpoints for Request Management (AC: 1, 2, 3)
  - [x] Create GET /api/v1/maintenance-requests endpoint with filtering
  - [x] Create GET /api/v1/maintenance-requests/{id} endpoint for details
  - [x] Implement proper authorization (MAINTENANCE_MANAGER role required)
  - [x] Add request validation with Pydantic schemas
  - [x] Return paginated results with metadata

- [x] Create API Client Functions for Dashboard (AC: 1, 2, 3)
  - [x] Create maintenanceRequestApi functions for dashboard operations
  - [x] Implement filtering and pagination parameters
  - [x] Add error handling for API failures
  - [x] Add real-time data fetching with React Query
  - [x] Implement optimistic updates for better UX

- [x] Implement Status Update Tracking (AC: 2, 5)
  - [x] Create status change history tracking
  - [x] Add automatic timestamp recording for status changes
  - [x] Implement status change notifications
  - [x] Add status change audit logging
  - [x] Display status change timeline in request details

## Dev Notes

### Previous Story Insights

From Story 3.1 (Problem Reporting Interface):
- Maintenance requests are successfully created with PENDING status
- File attachments are properly linked to maintenance requests
- Problem reporting form captures all required information (description, priority, failure code, maintenance type)
- QR scanner integration established for problem reporting workflow
- Backend API endpoints exist for maintenance request creation and file uploads
- Database schema includes failureCodeId and maintenanceTypeId foreign keys

**Key Implementation Notes:**
- Dashboard should display requests created from Story 3.1
- Real-time updates needed to show status changes across all users
- Mobile-responsive design required for managers accessing dashboard on mobile devices
- Integration with existing maintenance request data model and relationships
- Focus on viewing and monitoring capabilities, not assignment functionality

### Data Models

**MaintenanceRequest Model** [Source: architecture.md#data-models-maintenance-request-model]:
```typescript
enum RequestStatus {
  PENDING = 'PENDING',
  IN_PROGRESS = 'IN_PROGRESS',
  WAITING_PARTS = 'WAITING_PARTS',
  COMPLETED = 'COMPLETED',
  CANCELLED = 'CANCELLED'
}

enum Priority {
  LOW = 'LOW',
  MEDIUM = 'MEDIUM',
  HIGH = 'HIGH',
  CRITICAL = 'CRITICAL'
}

interface MaintenanceRequest {
  id: number;
  machineId: number;
  reporterId: number;
  status: RequestStatus;
  priority: Priority;
  reportedAt: Date;
  problemDescription: string;
  failureCodeId: number | null;
  maintenanceTypeId: number | null;
  createdAt: Date;
  updatedAt: Date;
  
  // Relations
  machine: Machine;
  reporter: User;
  maintenanceWork: MaintenanceWork | null;
  attachments: Attachment[];
  failureCode: FailureCode | null;
  maintenanceType: MaintenanceType | null;
}
```

**User Model** [Source: architecture.md#data-models-user-model]:
```typescript
enum UserRole {
  ADMIN = 'ADMIN',
  SUPERVISOR = 'SUPERVISOR',
  MAINTENANCE_TECH = 'MAINTENANCE_TECH',
  MAINTENANCE_MANAGER = 'MAINTENANCE_MANAGER',
  INVENTORY_MANAGER = 'INVENTORY_MANAGER'
}

interface User {
  id: number;
  username: string;
  fullName: string;
  role: UserRole;
  createdAt: Date;
  updatedAt: Date;
}
```

### API Specifications

**Get Maintenance Requests Endpoint** [Source: architecture.md#architectural-patterns]:
- Method: GET
- Path: `/api/v1/maintenance-requests`
- Authentication: Required (Bearer token)
- Authorization: MAINTENANCE_MANAGER role required
- Query Parameters:
  ```typescript
  {
    status?: RequestStatus;
    priority?: Priority;
    machineId?: number;
    reporterId?: number;
    startDate?: string; // ISO date string
    endDate?: string;   // ISO date string
    search?: string;    // Search in problem description
    page?: number;      // Pagination
    limit?: number;    // Items per page
  }
  ```
- Response: Paginated list of maintenance requests with full details
- Error Handling: 400 for invalid parameters, 401 for unauthorized, 403 for forbidden

**Get Maintenance Request Details Endpoint** [Source: architecture.md#architectural-patterns]:
- Method: GET
- Path: `/api/v1/maintenance-requests/{id}`
- Authentication: Required (Bearer token)
- Authorization: MAINTENANCE_MANAGER or MAINTENANCE_TECH role required
- Response: Complete maintenance request with all relations and attachments
- Error Handling: 404 for request not found, 403 for forbidden

### Component Specifications

**MaintenanceRequestDashboard Component**:
- Location: `frontend/src/components/maintenance/MaintenanceRequestDashboard.tsx`
- Props: `filters?: RequestFilters, onRequestSelect: (request: MaintenanceRequest) => void`
- Uses: React Query for data fetching, @tanstack/react-table for data table
- Dependencies: React 18.x, @tanstack/react-table 8.x, React Query 5.x
- Features:
  - Data table with sorting and filtering
  - Priority color coding (CRITICAL: red, HIGH: orange, MEDIUM: yellow, LOW: green)
  - Status badges with appropriate styling
  - Real-time updates with React Query
  - Export functionality (CSV, PDF)
  - Mobile-responsive design
  - Pagination with configurable page sizes

**RequestDetailModal Component**:
- Location: `frontend/src/components/maintenance/RequestDetailModal.tsx`
- Props: `request: MaintenanceRequest, isOpen: boolean, onClose: () => void`
- Features:
  - Complete request information display
  - File attachment preview and download
  - Request timeline/history
  - Status change tracking
  - Machine information display
  - Reporter information display

### File Locations

**Frontend Files** [Source: architecture.md#unified-project-structure]:
- `frontend/src/app/(dashboard)/maintenance/dashboard/page.tsx` - Maintenance dashboard page
- `frontend/src/components/maintenance/MaintenanceRequestDashboard.tsx` - Main dashboard component
- `frontend/src/components/maintenance/RequestDetailModal.tsx` - Request detail modal component
- `frontend/src/lib/api/maintenance-requests.ts` - API client for maintenance requests (extend existing)
- `frontend/src/lib/types.ts` - Add dashboard-specific types (extend existing)

**Backend Files** [Source: architecture.md#unified-project-structure]:
- `backend/app/api/v1/endpoints/maintenance_requests.py` - Extend existing endpoints
- `backend/app/schemas/maintenance_request.py` - Extend existing schemas
- `backend/app/services/maintenance_service.py` - Business logic for request management

### Technical Constraints

**Role-Based Access Control** [Source: architecture.md#tech-stack]:
- MAINTENANCE_MANAGER role required for dashboard access
- MAINTENANCE_TECH role can view assigned requests
- Proper authorization checks on all API endpoints
- Role validation in frontend components

**Real-Time Updates** [Source: architecture.md#tech-stack]:
- React Query for automatic data refetching
- Optimistic updates for better user experience
- Background refetching every 30 seconds
- Manual refresh capability
- WebSocket integration for live updates (future enhancement)

**Performance Considerations** [Source: architecture.md#architectural-patterns]:
- Pagination for large request lists (default 25 items per page)
- Lazy loading of request details
- Efficient filtering and search implementation
- Caching of technician lists and machine data
- Optimized database queries with proper indexing

**Mobile Responsiveness** [Source: architecture.md#tech-stack]:
- Mobile-first design for dashboard access
- Touch-friendly table interactions
- Collapsible columns on small screens
- Swipe gestures for mobile navigation
- Responsive modal dialogs

**Security Requirements** [Source: architecture.md#tech-stack]:
- Role-based access control enforcement
- Input validation and sanitization
- Audit logging for all dashboard operations
- Secure file attachment access
- Prevent unauthorized data access

### Testing Requirements

**Component Testing** [Source: architecture.md#tech-stack]:
- Unit tests for MaintenanceRequestDashboard component
- Test filtering and search functionality
- Test request detail modal with file previews
- Mock API responses for all client functions
- Test mobile responsiveness
- Test role-based access control

**Integration Testing**:
- Test complete dashboard workflow: load → filter → view details
- Test real-time updates with React Query
- Test file attachment display and download
- Test error scenarios (network failures, validation errors)
- Verify proper activity logging

**API Testing**:
- Test maintenance request listing endpoint with all filters
- Test request details endpoint with relations
- Test authorization requirements (MAINTENANCE_MANAGER role)
- Test input validation and error handling
- Verify proper database queries for dashboard data

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-01-XX | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (Dev Agent)

### Debug Log References

- All maintenance request dashboard tasks completed successfully
- Backend API endpoints implemented with comprehensive filtering and authorization
- Frontend dashboard component created with real-time updates using React Query
- Status update tracking implemented with activity logging
- No linting errors in the implementation

### Completion Notes List

1. **Maintenance Request Dashboard Component**: Successfully created comprehensive dashboard
   - Responsive layout with data table displaying all maintenance requests
   - Advanced filtering by status, priority, machine, and date range
   - Search functionality with debounced input for request descriptions
   - Color-coded priority and status indicators for visual clarity
   - Pagination support for large request lists with configurable page sizes
   - Real-time updates using React Query with 30-second refresh intervals
   - Mobile-responsive design with touch-friendly interface elements

2. **Request Detail View Component**: Implemented comprehensive detail modal
   - Complete request information display including machine, reporter, and problem details
   - Status and priority indicators with color coding
   - Timeline display showing requested date, expected completion, and actual completion
   - Additional information section with failure codes and maintenance types
   - Modal interface with proper accessibility and keyboard navigation
   - Mobile-optimized layout for field access

3. **Backend API Endpoints**: Created full REST API for request management
   - GET /api/v1/maintenance-requests endpoint with comprehensive filtering
   - GET /api/v1/maintenance-requests/{id} endpoint for detailed request information
   - PATCH /api/v1/maintenance-requests/{id}/status endpoint for status updates
   - Proper authorization with MAINTENANCE_MANAGER, ADMIN, and MAINTENANCE_TECH roles
   - Pydantic schemas for request validation and response formatting
   - Paginated results with metadata for efficient data handling

4. **API Client Functions**: Extended frontend API client layer
   - getRequests function with comprehensive filtering support
   - updateStatus function for status change operations
   - Proper TypeScript typing and error handling
   - URL parameter construction for complex filter combinations
   - Integration with React Query for caching and real-time updates

5. **Status Update Tracking**: Implemented comprehensive status change tracking
   - Activity logging for all status changes with user and timestamp information
   - Automatic timestamp recording for status transitions
   - Status change audit trail in database
   - Integration with existing ActivityLog model for comprehensive tracking
   - Support for status change notifications and history display

### File List

**Backend Files:**
- `backend/app/schemas/maintenance_request.py` - Added dashboard-specific schemas (MaintenanceRequestListResponse, MaintenanceRequestFilters)
- `backend/app/api/v1/endpoints/maintenance_requests.py` - Added GET endpoint with filtering, status update endpoint with tracking

**Frontend Files:**
- `frontend/src/lib/types.ts` - Added dashboard-specific types (MaintenanceRequestListResponse, MaintenanceRequestFilters)
- `frontend/src/lib/api/maintenance-requests.ts` - Added getRequests and updateStatus API functions
- `frontend/src/app/(dashboard)/maintenance/dashboard/page.tsx` - Created maintenance dashboard page
- `frontend/src/components/maintenance/MaintenanceRequestDashboard.tsx` - Main dashboard component with filtering and data table
- `frontend/src/components/maintenance/RequestDetailModal.tsx` - Request detail modal component

**Project Files:**
- `docs/stories/3.2.maintenance-request-dashboard-assignment.md` - Updated story with completion status

## QA Results

_This section will be populated by the QA agent during review_
