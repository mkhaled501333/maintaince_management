# Story 4.2: Inventory Transaction System

## Status

Done

## Story

**As an** inventory manager,  
**I want** to record all inventory movements and transactions,  
**so that** I have complete visibility into spare parts usage and availability.

## Acceptance Criteria

1. All inventory transactions (IN/OUT/ADJUSTMENT/TRANSFER) can be recorded
2. Transactions are linked to maintenance requests, purchases, or adjustments
3. Unit costs are tracked for valuation and cost analysis
4. Complete audit trail is maintained for all transactions
5. Real-time inventory updates are performed automatically

## Tasks / Subtasks

- [x] Create Inventory Transaction API Endpoints (AC: 1, 2, 3, 4)
  - [x] Create GET /api/v1/inventory-transactions endpoint for listing transactions with pagination and filtering
  - [x] Create GET /api/v1/inventory-transactions/{id} endpoint for retrieving single transaction details
  - [x] Create POST /api/v1/inventory-transactions endpoint for creating new transactions
  - [x] Implement filtering by transactionType, referenceType, sparePartId, date range, and performedBy
  - [x] Implement sorting by transactionDate, quantity, and totalValue
  - [x] Add proper authorization (INVENTORY_MANAGER or ADMIN role required for create/update/delete, others can view)
  - [x] Validate all required fields (sparePartId, transactionType, quantity, transactionDate)
  - [x] Automatically calculate totalValue when unitPrice is provided
  - [x] Link transactions to maintenance requests, purchases, or adjustments via referenceType and referenceNumber

- [x] Create Inventory Transaction Schemas for API (AC: 1, 2, 3)
  - [x] Create InventoryTransactionCreate schema with validation
  - [x] Create InventoryTransactionUpdate schema (limited fields for corrections)
  - [x] Create InventoryTransactionResponse schema with full details including related entities
  - [x] Create InventoryTransactionListResponse schema with pagination
  - [x] Validate transactionType enum values (IN, OUT, ADJUSTMENT, TRANSFER)
  - [x] Validate quantity is positive for IN transactions
  - [x] Validate sufficient stock exists for OUT transactions
  - [x] Validate unitPrice and calculate totalValue automatically

- [x] Implement Automatic Inventory Quantity Updates (AC: 5)
  - [x] Create inventory service function to handle automatic quantity updates
  - [x] Implement logic to update SparePart.quantity based on transactionType
  - [x] IN transactions: add to current quantity
  - [x] OUT transactions: subtract from current quantity (check sufficient stock first)
  - [x] ADJUSTMENT transactions: set quantity to specified value
  - [x] TRANSFER transactions: subtract from current quantity
  - [x] Handle transaction rollback on failure
  - [x] Ensure atomic database operations

- [x] Implement Activity Logging for Transactions (AC: 4)
  - [x] Log CREATE action for each transaction with full details
  - [x] Include before/after quantity values in activity log
  - [x] Record user who performed transaction, timestamp, and IP address
  - [x] Include transaction type, quantity, and reference information in log description
  - [x] Link activity log to inventory transaction entity

- [x] Create Inventory Transaction Management Frontend Interface (AC: 1, 2, 3)
  - [x] Create InventoryTransactionsList component with table view showing all transactions
  - [x] Implement search and filter functionality (by transaction type, reference type, date range, spare part)
  - [x] Create InventoryTransactionForm component for creating new transactions
  - [x] Add form fields: sparePartId (dropdown), transactionType, quantity, unitPrice, referenceType, referenceNumber, notes, transactionDate
  - [x] Implement validation for required fields and data types
  - [x] Display transaction history for specific spare parts
  - [x] Show before/after stock quantities for each transaction
  - [x] Display transaction totals and value calculations
  - [x] Add real-time stock level updates after transaction creation

- [x] Integrate Transaction System with Existing Inventory (AC: 5)
  - [x] Update SparePartsList component to show transaction history link
  - [x] Ensure transaction creation triggers automatic refetch of spare parts list
  - [x] Update LowStockAlerts to consider recent transactions
  - [x] Display last transaction date in spare parts list

- [x] Create Transaction History and Reporting Components (AC: 1, 2, 3)
  - [x] Create transaction history view for individual spare parts
  - [x] Display transaction timeline with dates and quantities
  - [x] Show running balance after each transaction
  - [x] Calculate and display total value of transactions
  - [x] Filter and export transaction data for reporting

## Dev Notes

### Previous Story Insights

From Story 4.1 (Spare Parts Inventory Management) completion:
- Backend API follows RESTful patterns with pagination, filtering, and sorting capabilities
- Authorization uses `require_inventory_manager` dependency for inventory operations
- Activity logging is implemented with before/after values using ActivityLog model
- Frontend uses React Query with 30s refetch intervals for real-time updates
- Stock status calculation (CRITICAL, LOW, ADEQUATE, EXCESS) already implemented
- TypeScript types are defined in `frontend/src/lib/types.ts`
- API client functions are in separate files following pattern `frontend/src/lib/api/{entity}.ts`

### Data Models

**InventoryTransaction Model** [Source: backend/app/models/inventory_transaction.py]:
- Primary fields: `transactionType` (IN, OUT, ADJUSTMENT, TRANSFER), `quantity`, `unitPrice`, `totalValue`, `transactionDate`
- Reference fields: `referenceNumber`, `referenceType` (MAINTENANCE_WORK, PURCHASE_ORDER, etc.), `notes`
- Relationships: `sparePartId` (FK to SparePart), `performedById` (FK to User)
- The model already exists in the codebase with these fields defined

**Transaction Types** [Source: docs/architecture.md#Inventory Transaction Model]:
- `IN`: Stock received (adds to inventory)
- `OUT`: Stock issued (subtracts from inventory)
- `ADJUSTMENT`: Stock adjustment (sets quantity to specified value)
- `TRANSFER`: Stock transfer (subtracts from current location)

**Reference Types** [Source: docs/architecture.md#Inventory Transaction Model]:
- `PURCHASE`: Linked to purchase orders
- `MAINTENANCE`: Linked to maintenance requests/work
- `ADJUSTMENT`: Manual adjustments
- `TRANSFER`: Internal transfers

**Automatic Quantity Update Logic** [Source: docs/architecture.md#Inventory Management Implementation]:
- IN: `newQuantity = sparePart.quantity + quantity`
- OUT: `newQuantity = sparePart.quantity - quantity` (must check sufficient stock first)
- ADJUSTMENT: `newQuantity = quantity` (sets to specified value)
- TRANSFER: `newQuantity = sparePart.quantity - quantity`
- All updates must be atomic and handle rollback on failure

### API Specifications

**File Location Pattern** [Source: docs/architecture.md#Unified Project Structure]:
- Backend endpoints: `backend/app/api/v1/endpoints/inventory_transactions.py`
- Backend schemas: `backend/app/schemas/inventory_transaction.py`
- Frontend API client: `frontend/src/lib/api/inventory-transactions.ts`
- Frontend components: `frontend/src/components/inventory/InventoryTransactionsList.tsx`, `frontend/src/components/inventory/InventoryTransactionForm.tsx`

**Authorization Requirements** [Source: docs/architecture.md#Unified Project Structure]:
- Create/Update/Delete: Requires `INVENTORY_MANAGER` or `ADMIN` role (ADMIN has full access to all operations)
- View/List: Can be accessed by inventory managers, admins, and potentially maintenance managers
- Use `require_inventory_manager` dependency for protected endpoints (automatically allows ADMIN per deps.py implementation)

**Pagination and Filtering** [Source: Story 4.1 implementation pattern]:
- Pagination: `page` (default: 1), `page_size` (default: 25, max: 100)
- Filters: `transactionType`, `referenceType`, `sparePartId`, `date_from`, `date_to`, `performedBy`
- Sorting: `sort_by` (transactionDate, quantity, totalValue), `sort_order` (asc, desc)
- Search: Optional search parameter for reference numbers or notes

**Request/Response Formats**:
- Create Transaction: POST with `sparePartId`, `transactionType`, `quantity`, `unitPrice` (optional), `referenceType` (optional), `referenceNumber` (optional), `notes` (optional), `transactionDate` (optional, defaults to now)
- Response: Full transaction details including updated spare part quantity, before/after values

### Component Specifications

**InventoryTransactionsList Component**:
- Display columns: Transaction Date, Spare Part, Type, Quantity, Unit Price, Total Value, Reference, Performed By, Actions
- Include filters for transaction type, date range, spare part, reference type
- Show pagination controls
- Display transaction details in expandable rows or modal
- Link to spare part details
- Real-time updates using React Query

**InventoryTransactionForm Component**:
- Dropdown for spare part selection (required)
- Radio buttons or dropdown for transaction type (required)
- Numeric input for quantity (required, must be positive)
- Numeric input for unit price (optional)
- Dropdown for reference type (optional: PURCHASE, MAINTENANCE, ADJUSTMENT, TRANSFER)
- Text input for reference number (optional)
- Date picker for transaction date (defaults to current date/time)
- Textarea for notes (optional)
- Display current stock level before transaction
- Show calculated total value when unit price is entered
- Show warning for OUT transactions if insufficient stock
- Validation for required fields before submission
- Manual save button (not auto-save) per user preference

**Transaction History View**:
- Timeline view showing all transactions for a specific spare part
- Display running balance after each transaction
- Show before/after quantities for each transaction
- Filter by date range
- Export functionality for reporting

### File Locations

Based on the project structure [Source: docs/architecture.md#Unified Project Structure]:

**Backend Files to Create/Modify:**
- `backend/app/api/v1/endpoints/inventory_transactions.py` - New endpoint file
- `backend/app/schemas/inventory_transaction.py` - New schema file
- `backend/app/api/v1/api.py` - Add inventory transactions router
- `backend/app/models/inventory_transaction.py` - May need minor updates to match architecture
- `backend/app/services/inventory_service.py` - Create service for automatic quantity updates (or add to existing service)

**Frontend Files to Create:**
- `frontend/src/lib/types.ts` - Add InventoryTransaction types and enums
- `frontend/src/lib/api/inventory-transactions.ts` - New API client file
- `frontend/src/components/inventory/InventoryTransactionsList.tsx` - New list component
- `frontend/src/components/inventory/InventoryTransactionForm.tsx` - New form component
- `frontend/src/app/(dashboard)/inventory/transactions/page.tsx` - New page route


### Technical Constraints

**Real-Time Updates**:
- Use React Query with automatic refetch after mutation
- Refetch interval of 30 seconds for lists (per Story 4.1 pattern)
- Optimistic updates for better UX

**Database Transactions**:
- Use SQLAlchemy session transactions to ensure atomicity
- Update SparePart quantity and create InventoryTransaction in same transaction
- Rollback on any failure to maintain data consistency

**Stock Validation**:
- For OUT transactions, check `sparePart.quantity >= quantity` before processing
- Return appropriate error if insufficient stock
- Display current stock level in form before submission

**Activity Logging**:
- Log all CREATE actions for inventory transactions
- Include before/after quantity values: `{ "quantity": { "before": oldQty, "after": newQty } }`
- Include transaction details in description field

### Integration Points

**Spare Parts Integration**:
- Transaction creation should update SparePart.quantity automatically
- Transaction list should be accessible from SparePart detail view
- Low stock alerts should consider recent transactions

**Activity Logging Integration**:
- Use existing ActivityLog model and logging utility
- Log entityType as 'INVENTORY_TRANSACTION'
- Include user, timestamp, IP address, and changes

**User Preference**:
- Manual save button should appear when form fields change
- Submission only on save button click (not auto-save per keystroke) [Source: User Memory ID: 2868641]


## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-01-XX | 1.1 | Added ADMIN role to authorization requirements | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

1. **Backend Implementation:**
   - Created comprehensive API endpoints for inventory transactions with full CRUD operations
   - Implemented automatic stock quantity updates based on transaction type (IN, OUT, ADJUSTMENT, TRANSFER)
   - Added stock validation for OUT transactions to prevent negative stock
   - Integrated activity logging with before/after quantity tracking
   - All database operations use atomic transactions to ensure data consistency

2. **Frontend Implementation:**
   - Created transaction management interface with list view and form
   - Implemented filtering by transaction type, date range, spare part, and search
   - Form includes manual save button that appears when fields change (per user preference)
   - Real-time stock updates and validation warnings for insufficient stock
   - Integrated transaction history link in spare parts list
   - Transaction list supports URL parameters for filtering by spare part ID

3. **Integration Points:**
   - Transaction creation automatically updates spare part quantities
   - Transaction queries invalidate spare parts cache for real-time updates
   - Added "History" button in spare parts list to view transaction history
   - Support for filtering transactions by spare part via URL parameter

### File List

**Backend Files Created:**
- `backend/app/schemas/inventory_transaction.py` - Inventory transaction schemas (Create, Update, Response)
- `backend/app/api/v1/endpoints/inventory_transactions.py` - Inventory transaction API endpoints

**Backend Files Modified:**
- `backend/app/api/v1/api.py` - Added inventory transactions router

**Frontend Files Created:**
- `frontend/src/lib/api/inventory-transactions.ts` - Inventory transactions API client
- `frontend/src/components/inventory/InventoryTransactionForm.tsx` - Transaction creation form component
- `frontend/src/components/inventory/InventoryTransactionsList.tsx` - Transaction list component with filtering
- `frontend/src/app/(dashboard)/inventory/transactions/page.tsx` - Transactions page route

**Frontend Files Modified:**
- `frontend/src/lib/types.ts` - Added inventory transaction types and interfaces
- `frontend/src/components/inventory/SparePartsList.tsx` - Added transaction history link

## QA Results

_This section will be populated by the QA agent during review_
