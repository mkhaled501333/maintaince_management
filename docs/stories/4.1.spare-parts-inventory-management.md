# Story 4.1: Spare Parts Inventory Management

## Status

Done

## Story

**As an** inventory manager,  
**I want** to manage spare parts inventory with comprehensive tracking,  
**so that** spare parts are properly organized and available when needed.

## Acceptance Criteria

1. Spare parts can be created, edited, and deleted with all required information
2. Inventory levels are tracked in real-time
3. Low stock alerts are generated when quantities fall below minimum levels
4. Spare parts are organized by groups and categories
5. Location tracking is implemented for physical inventory management

## Tasks / Subtasks

- [x] Create Spare Parts Management API Endpoints (AC: 1, 4)
  - [x] Create GET /api/v1/spare-parts endpoint for listing spare parts with pagination and filtering
  - [x] Create GET /api/v1/spare-parts/{id} endpoint for retrieving single spare part details
  - [x] Create POST /api/v1/spare-parts endpoint for creating new spare parts
  - [x] Create PATCH /api/v1/spare-parts/{id} endpoint for updating spare parts
  - [x] Create DELETE /api/v1/spare-parts/{id} endpoint for deleting spare parts (soft delete via isActive flag)
  - [x] Implement filtering by category, groupNumber, search term, and stock status
  - [x] Implement sorting by partNumber, name, currentStock, and category
  - [x] Add proper authorization (INVENTORY_MANAGER role required)
  - [x] Validate all required fields (partNumber, name, currentStock, minimumStock)

- [x] Create Spare Parts Schemas for API (AC: 1)
  - [x] Create SparePartCreate schema with validation
  - [x] Create SparePartUpdate schema (all fields optional)
  - [x] Create SparePartResponse schema with full details
  - [x] Create SparePartListResponse schema with pagination
  - [x] Validate partNumber uniqueness
  - [x] Validate numeric fields (quantities, prices) are non-negative

- [x] Create Spare Parts Management Frontend Interface (AC: 1, 4, 5)
  - [x] Create SparePartsList component with table view showing all parts
  - [x] Implement search and filter functionality (by part number, name, category, stock status)
  - [x] Create SparePartForm component for creating/editing spare parts
  - [x] Add form fields: partNumber, name, description, category, currentStock, minimumStock, maximumStock, unitPrice, supplier, supplierPartNumber, location
  - [x] Implement validation for required fields and data types
  - [x] Add delete functionality with confirmation dialog
  - [x] Display location information for physical inventory management
  - [x] Show category and group organization in list view

- [x] Implement Real-Time Inventory Tracking (AC: 2)
  - [x] Use React Query for automatic data refetching
  - [x] Implement optimistic updates for better UX
  - [x] Display current stock levels in list and detail views
  - [x] Add refresh button for manual data updates
  - [x] Show last updated timestamp for stock levels

- [x] Create Low Stock Alert System (AC: 3)
  - [x] Backend: Create GET /api/v1/spare-parts/low-stock endpoint for parts below minimum
  - [x] Frontend: Display low stock alert indicator in list view
  - [x] Frontend: Create LowStockAlerts component/widget
  - [x] Calculate stock status (CRITICAL: < min, LOW: < min*1.5, ADEQUATE, EXCESS: > max)
  - [x] Visual indicators (colors/badges) for stock status
  - [x] Filter by stock status in list view

- [x] Create API Client Functions for Frontend (AC: 1, 2, 3)
  - [x] Create sparePartsApi.getSpareParts() function with filtering and pagination
  - [x] Create sparePartsApi.getSparePart() function for single part
  - [x] Create sparePartsApi.createSparePart() function
  - [x] Create sparePartsApi.updateSparePart() function
  - [x] Create sparePartsApi.deleteSparePart() function
  - [x] Create sparePartsApi.getLowStockParts() function
  - [x] Implement proper TypeScript typing and error handling
  - [x] Add React Query integration for caching and updates

- [x] Implement Activity Logging for Spare Parts (AC: 1)
  - [x] Log CREATE actions when spare parts are created
  - [x] Log UPDATE actions with before/after values for changes
  - [x] Log DELETE actions when spare parts are deactivated
  - [x] Include user information and timestamps in logs
  - [x] Track stock level changes separately for audit trail

## Dev Notes

### Previous Story Insights

From Story 3.3 (Technician Request Management):
- Real-time updates implemented using React Query with automatic refetching
- Activity logging established for tracking user actions
- Authorization patterns established for role-based access control
- API client patterns established with proper TypeScript typing

**Key Implementation Notes:**
- This is the first story for inventory management - foundation for all spare parts functionality
- Inventory transactions will be implemented in Story 4.2, so stock levels in this story are manual/managed
- Low stock alerts are visual indicators only - automated notifications can be added later
- PartNumber must be unique across all spare parts
- Soft delete using isActive flag maintains data integrity for historical transactions
- Location tracking enables physical inventory management in warehouses/storage areas

### Data Models

**SparePart Model** [Source: backend/app/models/spare_part.py]:
```python
class SparePart(BaseModel):
    __tablename__ = "spareparts"
    
    # Part information
    partNumber: str  # Column(String(100), unique=True, nullable=False)
    name: str  # Column(String(200), nullable=False)
    description: str | None  # Column(Text, nullable=True)
    category: str | None  # Column(String(100), nullable=True)
    
    # Inventory information
    currentStock: int  # Column(Integer, nullable=False, default=0)
    minimumStock: int  # Column(Integer, nullable=False, default=0)
    maximumStock: int | None  # Column(Integer, nullable=True)
    unitPrice: float | None  # Column(Float, nullable=True)
    
    # Supplier information
    supplier: str | None  # Column(String(200), nullable=True)
    supplierPartNumber: str | None  # Column(String(100), nullable=True)
    
    # Location (for physical inventory management)
    # Note: Architecture doc mentions location field in TypeScript interface
    # Backend model may need location field addition if not present
    
    # Status
    isActive: bool  # Column(Boolean, default=True, nullable=False)
    
    # Relationships
    inventoryTransactions: List[InventoryTransaction]  # relationship
    machineSpareParts: List[MachineSparePart]  # relationship
```

**TypeScript Interface** [Source: architecture.md#data-models-spare-part-model]:
```typescript
interface SparePart {
  id: number;
  partNumber: string;
  partName: string;  // Note: field name differs from backend (name vs partName)
  description: string | null;
  groupNumber: string | null;
  groupName: string | null;
  quantity: number;  // Note: field name differs from backend (currentStock vs quantity)
  minQuantity: number;  // Note: field name differs (minimumStock vs minQuantity)
  unitPrice: number | null;
  location: string | null;  // Location tracking for physical inventory
  createdAt: Date;
  updatedAt: Date;
  
  // Relations
  inventoryTransactions: InventoryTransaction[];
  sparePartsRequests: SparePartsRequest[];
  machines: MachineSparePart[];
  attachments: Attachment[];
}
```

**Key Field Mappings:**
- Backend uses `name`, frontend TypeScript uses `partName` - need to map in schemas
- Backend uses `currentStock`, frontend uses `quantity` - need to map in schemas
- Backend uses `minimumStock`, frontend uses `minQuantity` - need to map in schemas
- Backend model may not have `location` field - verify and add if missing
- Backend model may not have `groupNumber`/`groupName` fields - verify and add if needed for AC #4

### API Specifications

**List Spare Parts Endpoint** [Source: architecture.md#architectural-patterns]:
- Method: GET
- Path: `/api/v1/spare-parts`
- Authentication: Required (Bearer token)
- Authorization: INVENTORY_MANAGER role required
- Query Parameters:
  ```typescript
  {
    page?: number;  // Default: 1
    page_size?: number;  // Default: 25, max: 100
    search?: string;  // Search in partNumber, name, description
    category?: string;  // Filter by category
    group_number?: string;  // Filter by groupNumber
    stock_status?: 'CRITICAL' | 'LOW' | 'ADEQUATE' | 'EXCESS';  // Filter by stock status
    is_active?: boolean;  // Filter by active status
    sort_by?: 'partNumber' | 'name' | 'currentStock' | 'category';  // Sort field
    sort_order?: 'asc' | 'desc';  // Sort direction
  }
  ```
- Response: Paginated list of spare parts
- Response Model:
  ```typescript
  {
    spareParts: SparePart[];
    total: number;
    page: number;
    pageSize: number;
    totalPages: number;
  }
  ```

**Get Single Spare Part Endpoint**:
- Method: GET
- Path: `/api/v1/spare-parts/{id}`
- Authentication: Required
- Authorization: INVENTORY_MANAGER role required
- Response: Single SparePart with full details
- Error Handling: 404 if not found, 403 if unauthorized

**Create Spare Part Endpoint**:
- Method: POST
- Path: `/api/v1/spare-parts`
- Authentication: Required
- Authorization: INVENTORY_MANAGER role required
- Request Body:
  ```typescript
  {
    partNumber: string;  // Required, must be unique
    name: string;  // Required
    description?: string;
    category?: string;
    currentStock: number;  // Required, default: 0
    minimumStock: number;  // Required, default: 0
    maximumStock?: number;
    unitPrice?: number;
    supplier?: string;
    supplierPartNumber?: string;
    location?: string;  // For AC #5
  }
  ```
- Response: Created SparePart
- Error Handling: 400 for validation errors, 409 if partNumber already exists, 403 if unauthorized

**Update Spare Part Endpoint**:
- Method: PATCH
- Path: `/api/v1/spare-parts/{id}`
- Authentication: Required
- Authorization: INVENTORY_MANAGER role required
- Request Body: Same as Create, but all fields optional
- Response: Updated SparePart
- Error Handling: 404 if not found, 400 for validation errors, 409 if partNumber already exists

**Delete Spare Part Endpoint**:
- Method: DELETE
- Path: `/api/v1/spare-parts/{id}`
- Authentication: Required
- Authorization: INVENTORY_MANAGER role required
- Implementation: Soft delete by setting isActive=false (maintains data integrity)
- Response: 204 No Content on success
- Error Handling: 404 if not found, 403 if unauthorized

**Low Stock Parts Endpoint**:
- Method: GET
- Path: `/api/v1/spare-parts/low-stock`
- Authentication: Required
- Authorization: INVENTORY_MANAGER role required
- Query Parameters: Same as list endpoint filters
- Response: List of spare parts where currentStock < minimumStock
- Error Handling: 403 if unauthorized

### Component Specifications

**SparePartsList Component**:
- Location: `frontend/src/components/inventory/SparePartsList.tsx`
- Props: None (uses current user from auth context)
- Uses: React Query for data fetching, @tanstack/react-table for table display
- Features:
  - Table display with columns: Part Number, Name, Category, Location, Current Stock, Min Stock, Max Stock, Status, Actions
  - Search bar for filtering by part number or name
  - Filter dropdowns for category and stock status
  - Sortable columns
  - Pagination controls
  - Real-time updates using React Query
  - Stock status indicators with color coding (CRITICAL: red, LOW: orange, ADEQUATE: green, EXCESS: yellow)
  - Edit and Delete action buttons
  - Create new spare part button
  - Low stock alert badge/indicator

**SparePartForm Component**:
- Location: `frontend/src/components/inventory/SparePartForm.tsx`
- Props: `sparePart?: SparePart, onSave: (data: SparePart) => void, onCancel: () => void`
- Uses: react-hook-form for form state management
- Features:
  - Form fields for all SparePart attributes
  - Validation for required fields (partNumber, name, currentStock, minimumStock)
  - Number input validation (non-negative values)
  - Part number uniqueness check (show error if duplicate)
  - Save and Cancel buttons
  - Loading state during submission
  - Error message display

**LowStockAlerts Component**:
- Location: `frontend/src/components/inventory/LowStockAlerts.tsx`
- Props: `limit?: number` (default: 10)
- Uses: React Query to fetch low stock parts
- Features:
  - List of spare parts below minimum stock
  - Count badge showing number of low stock items
  - Link to full spare parts list filtered by low stock
  - Can be used as dashboard widget

### File Locations

**Frontend Files** [Source: architecture.md#unified-project-structure]:
- `frontend/src/app/(dashboard)/inventory/spare-parts/page.tsx` - Spare parts management page
- `frontend/src/components/inventory/SparePartsList.tsx` - Main list component
- `frontend/src/components/inventory/SparePartForm.tsx` - Create/edit form component
- `frontend/src/components/inventory/LowStockAlerts.tsx` - Low stock alerts widget
- `frontend/src/lib/api/spare-parts.ts` - API client for spare parts endpoints
- `frontend/src/lib/types.ts` - Add SparePart types (may already exist from Story 1.1)

**Backend Files** [Source: architecture.md#unified-project-structure]:
- `backend/app/api/v1/endpoints/spare_parts.py` - New endpoint file for spare parts CRUD
- `backend/app/api/v1/api.py` - Add spare-parts router
- `backend/app/schemas/spare_part.py` - New schemas for spare parts (Create, Update, Response, ListResponse)
- `backend/app/models/spare_part.py` - SparePart model (already exists, verify location field)
- `backend/app/core/deps.py` - require_inventory_manager dependency (already exists)

### Technical Constraints

**Role-Based Access Control** [Source: backend/app/core/deps.py]:
- INVENTORY_MANAGER role required for all spare parts operations
- Proper authorization checks on all API endpoints
- Role validation in frontend components
- Only inventory managers can create, edit, or delete spare parts

**Real-Time Updates** [Source: architecture.md#tech-stack]:
- React Query for automatic data refetching every 30 seconds
- Optimistic updates for better user experience
- Manual refresh capability
- Background refetching when window regains focus

**Stock Status Calculation** [Source: architecture.md]:
- CRITICAL: currentStock < minimumStock
- LOW: currentStock < minimumStock * 1.5
- ADEQUATE: minimumStock * 1.5 <= currentStock <= maximumStock (if set)
- EXCESS: currentStock > maximumStock (if set)

**Soft Delete Implementation**:
- Use isActive flag instead of hard delete
- Maintains referential integrity for historical transactions
- isActive=false parts should not appear in normal list views (use filter for viewing inactive)
- Activity log should track deactivation

**Field Name Mapping**:
- Backend uses camelCase (partNumber, currentStock, minimumStock)
- Frontend TypeScript interface uses different naming (partName, quantity, minQuantity)
- Must handle mapping in Pydantic schemas and API client
- Ensure consistent field naming across frontend and backend

**Location Tracking** (AC: 5):
- Verify backend SparePart model has location field
- If missing, add location: Column(String(200), nullable=True) to model
- Create migration to add location column to spareparts table
- Frontend form should include location input field
- List view should display location column

**Category and Group Organization** (AC: 4):
- Verify backend model supports category (already present) and groupNumber/groupName
- If groupNumber/groupName missing, add to model and create migration
- Frontend should support filtering and grouping by category
- Frontend should display category in list and detail views


## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-01-XX | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
- Backend API endpoints created and tested
- Frontend components implemented with React Query integration
- Migration created for location field addition
- All linting checks passed

### Completion Notes List
1. **Backend API Implementation**
   - Created comprehensive CRUD API endpoints for spare parts management
   - Implemented pagination, filtering, and sorting capabilities
   - Added stock status calculation (CRITICAL, LOW, ADEQUATE, EXCESS)
   - Implemented proper authorization using INVENTORY_MANAGER role
   - Added activity logging for CREATE, UPDATE, and DELETE operations with before/after values

2. **Database Changes**
   - Added `location` field to SparePart model for physical inventory management
   - Created migration file for location field addition

3. **Frontend Implementation**
   - Created SparePartsList component with real-time updates using React Query (30s refetch interval)
   - Implemented SparePartForm component with full validation
   - Created LowStockAlerts widget component for dashboard integration
   - Added comprehensive filtering by category, stock status, and search
   - Implemented sortable columns in table view
   - Added visual indicators for stock status with color coding

4. **Type Safety**
   - Added complete TypeScript types for spare parts
   - Created API client with proper typing and error handling
   - Integrated with existing React Query setup

5. **Real-Time Features**
   - Automatic data refetching every 30 seconds
   - Manual refresh capability
   - Optimistic updates for better UX

### File List

**Backend Files:**
- `backend/app/models/spare_part.py` - Updated with location field
- `backend/app/schemas/spare_part.py` - New schemas for API validation
- `backend/app/api/v1/endpoints/spare_parts.py` - New API endpoints
- `backend/app/api/v1/api.py` - Updated to include spare parts router
- `backend/alembic/versions/205d7d00674d_add_location_field_to_spare_parts.py` - Migration file

**Frontend Files:**
- `frontend/src/lib/types.ts` - Added SparePart types and interfaces
- `frontend/src/lib/api/spare-parts.ts` - New API client functions
- `frontend/src/components/inventory/SparePartsList.tsx` - New list component
- `frontend/src/components/inventory/SparePartForm.tsx` - New form component
- `frontend/src/components/inventory/LowStockAlerts.tsx` - New low stock widget
- `frontend/src/app/(dashboard)/inventory/spare-parts/page.tsx` - New page route

### Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-01-XX | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-10-28 | 1.1 | Completed implementation of spare parts inventory management system | James (Dev Agent) |

## QA Results

_This section will be populated by the QA agent during review_

