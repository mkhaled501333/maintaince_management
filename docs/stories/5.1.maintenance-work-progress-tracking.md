# Story 5.1: Maintenance Work Progress Tracking

## Status

Done



## Story

**As a** maintenance technician,  
**I want** to update my work progress and record maintenance steps,  
**so that** maintenance work is properly documented and tracked.

## Acceptance Criteria

1. Work progress can be updated with detailed maintenance steps
2. Work description and notes can be recorded
3. Work start and completion times are tracked
4. Status updates are properly logged and visible
5. Work completion triggers automatic downtime calculation

## Tasks / Subtasks

- [x] Create Maintenance Work Progress API Endpoints (AC: 1, 2, 3, 4)
  - [x] Create GET /api/v1/maintenance-work/{id} endpoint for retrieving work details
  - [x] Create PATCH /api/v1/maintenance-work/{id}/start endpoint for starting work
  - [x] Create PATCH /api/v1/maintenance-work/{id}/update-progress endpoint for updating progress
  - [x] Create PATCH /api/v1/maintenance-work/{id}/complete endpoint for completing work
  - [x] Implement maintenance steps JSON array handling (step, description, completed, completedAt)
  - [x] Add proper authorization (MAINTENANCE_TECH for own work, ADMIN for all)
  - [x] Validate work belongs to technician or user has admin role
  - [x] Validate work status transitions (PENDING → IN_PROGRESS → COMPLETED)

- [x] Create Maintenance Work Progress Schemas (AC: 1, 2, 3)
  - [x] Create MaintenanceWorkStart schema with validation
  - [x] Create MaintenanceWorkProgressUpdate schema with maintenanceSteps array
  - [x] Create MaintenanceWorkComplete schema with workDescription and completion notes
  - [x] Create MaintenanceWorkResponse schema with full details including steps
  - [x] Validate maintenanceSteps array structure and required fields
  - [x] Validate workDescription is not empty when completing work
  - [x] Validate startedAt and completedAt timestamps

- [x] Implement Work Progress Tracking Logic (AC: 1, 2, 3, 4)
  - [x] Auto-set startedAt timestamp when work is started
  - [x] Auto-set completedAt timestamp when work is completed
  - [x] Update maintenance request status to IN_PROGRESS when work starts
  - [x] Update maintenance request status to COMPLETED when work finishes
  - [x] Track individual step completion with timestamps
  - [x] Create activity log entries for all progress updates
  - [x] Validate step completion sequence and dependencies

- [x] Implement Automatic Downtime Calculation (AC: 5)
  - [x] Trigger downtime calculation when work is completed
  - [x] Create MachineDowntime record with startTime and endTime
  - [x] Calculate duration in minutes automatically
  - [x] Set downtimeType to MAINTENANCE
  - [x] Link downtime to maintenance request
  - [x] Update machine status based on downtime

- [x] Create Maintenance Work Progress Frontend Components (AC: 1, 2, 3)
  - [x] Create MaintenanceWorkProgress component for technicians
  - [x] Create MaintenanceStepsList component with step tracking
  - [x] Create WorkProgressForm component for updating progress
  - [x] Create WorkCompletionForm component for finishing work
  - [x] Add progress indicators and visual step completion
  - [x] Show work duration and time tracking
  - [x] Display maintenance request details and context

- [x] Create Frontend API Client for Maintenance Work (AC: 1, 2, 3, 4)
  - [x] Create maintenance-work.ts API client with all operations
  - [x] Implement startWork function
  - [x] Implement updateProgress function
  - [x] Implement completeWork function
  - [x] Add React Query hooks for data fetching and caching
  - [x] Implement optimistic updates for better UX
  - [x] Add real-time progress updates

- [x] Add Integration with Maintenance Request System (AC: 4, 5)
  - [x] Update maintenance request status when work progresses
  - [x] Show work progress in maintenance request detail view
  - [x] Link work completion to downtime calculation
  - [x] Display work history and completion timeline
  - [x] Integrate with existing maintenance request workflow

- [x] Implement Activity Logging (AC: 4)
  - [x] Log START action when work is started
  - [x] Log UPDATE action when progress is updated
  - [x] Log COMPLETE action when work is completed
  - [x] Include work details, steps completed, and duration in logs
  - [x] Track step-by-step completion for detailed audit trail

## Dev Notes

### Previous Story Insights

From Story 4.3 (Spare Parts Request and Approval Workflow):
- Manual save button pattern: Form fields should show a save button when changed, submission only on button click [Source: User Memory ID: 2868641]
- Real-time updates: Use React Query with automatic refetch after mutation
- Database transactions: Use SQLAlchemy session transactions for atomicity
- Activity logging: Include before/after values and details in activity logs
- Status workflow: Follow proper status transitions with validation

### Data Models

**MaintenanceWork Model** [Source: architecture.md#410-454]:
- Fields: `id`, `requestId`, `technicianId`, `startedAt`, `completedAt`, `workDescription`, `maintenanceSteps`
- maintenanceSteps: JSON array of MaintenanceStep objects with step, description, completed, completedAt
- Status tracking: Work progresses from PENDING → IN_PROGRESS → COMPLETED
- Relationships:
  - Belongs to MaintenanceRequest (one-to-one) - work is associated with a request
  - Belongs to User as technician (many-to-one) - technician performing work
  - Has many SparePartsRequests (one-to-many) - parts requested during work

**MaintenanceStep Interface** [Source: architecture.md#425-430]:
```typescript
interface MaintenanceStep {
  step: number;
  description: string;
  completed: boolean;
  completedAt?: Date;
}
```

**MaintenanceRequest Integration** [Source: architecture.md#345-407]:
- MaintenanceRequest status updates: PENDING → IN_PROGRESS → COMPLETED
- MaintenanceRequest has one MaintenanceWork record (one-to-one)
- Status changes trigger automatic downtime calculation

**MachineDowntime Model** [Source: architecture.md#833-878]:
- Fields: `id`, `machineId`, `requestId`, `startTime`, `endTime`, `durationMinutes`, `downtimeType`, `autoCalculated`
- downtimeType: MAINTENANCE for maintenance-related downtime
- autoCalculated: true for automatic calculations
- Duration calculated automatically in minutes

### API Specifications

**Endpoints to Create** [Source: architecture.md#1138-1157]:
```
GET    /api/v1/maintenance-work/{id}                    # Get work details
PATCH  /api/v1/maintenance-work/{id}/start              # Start work
PATCH  /api/v1/maintenance-work/{id}/update-progress    # Update progress
PATCH  /api/v1/maintenance-work/{id}/complete           # Complete work
```

**Authorization Requirements** [Source: Previous stories pattern]:
- START/UPDATE/COMPLETE: MAINTENANCE_TECH (own work) or ADMIN role required
- VIEW: All authenticated users can view work details
- Technicians can only modify their own assigned work

**Request Validation**:
- Work must exist and belong to the requesting technician (unless admin)
- Work status must allow the requested transition
- maintenanceSteps array must be properly formatted
- workDescription required when completing work
- Timestamps must be valid and sequential

### Component Specifications

**Backend File Locations** [Source: architecture.md#1057-1230]:
- Model: `backend/app/models/maintenance_work.py` (already exists, may need updates)
- Schema: `backend/app/schemas/maintenance_work.py` (already exists, may need updates)
- API Endpoints: `backend/app/api/v1/endpoints/maintenance_work.py` (already exists, may need updates)
- Service: `backend/app/services/maintenance_service.py` (already exists, may need updates)

**Frontend File Locations** [Source: architecture.md#1057-1230]:
- API Client: `frontend/src/lib/api/maintenance-work.ts` (may need updates)
- Components: `frontend/src/components/maintenance/MaintenanceWorkProgress.tsx`, `MaintenanceStepsList.tsx`, `WorkProgressForm.tsx`, `WorkCompletionForm.tsx`
- Types: `frontend/src/lib/types.ts` (add MaintenanceStep interfaces)
- Page/Route: Integrate into existing maintenance work pages

**Component Patterns** [Source: Story 4.3]:
- Use React Query for data fetching with useQuery and useMutation hooks
- Manual save button pattern: Show save button when form fields change
- Optimistic updates for better UX
- Real-time updates with automatic cache invalidation
- Step-by-step progress tracking with visual indicators

### File Locations

**Backend Files to Create/Modify**:
- `backend/app/models/maintenance_work.py` - Verify MaintenanceStep JSON handling
- `backend/app/schemas/maintenance_work.py` - Add progress update schemas
- `backend/app/api/v1/endpoints/maintenance_work.py` - Add progress endpoints
- `backend/app/services/maintenance_service.py` - Add progress tracking logic
- `backend/app/services/downtime_service.py` - Add automatic downtime calculation

**Frontend Files to Create**:
- `frontend/src/lib/api/maintenance-work.ts` - Add progress API functions
- `frontend/src/components/maintenance/MaintenanceWorkProgress.tsx` - Main progress component
- `frontend/src/components/maintenance/MaintenanceStepsList.tsx` - Steps tracking component
- `frontend/src/components/maintenance/WorkProgressForm.tsx` - Progress update form
- `frontend/src/components/maintenance/WorkCompletionForm.tsx` - Work completion form

**Frontend Files to Modify**:
- `frontend/src/lib/types.ts` - Add MaintenanceStep and progress-related types
- `frontend/src/app/(dashboard)/maintenance/work/[id]/page.tsx` - Add progress tracking section
- `frontend/src/components/maintenance/RequestDetailModal.tsx` - Show work progress

### Technical Constraints

**Work Status Management**:
- Work status must follow sequence: PENDING → IN_PROGRESS → COMPLETED
- Cannot start work that's already completed
- Cannot complete work that hasn't been started
- Cannot update progress on completed work

**Step Tracking**:
- maintenanceSteps stored as JSON array in database
- Each step has: step number, description, completed boolean, completedAt timestamp
- Steps should be completed in order (step 1 before step 2, etc.)
- Completed steps cannot be uncompleted

**Time Tracking**:
- startedAt set automatically when work is started
- completedAt set automatically when work is completed
- Duration calculated as completedAt - startedAt
- Time tracking should be accurate and tamper-resistant

**Database Transactions**:
- Work completion must be atomic: Update work status + Update request status + Create downtime record + Create activity log
- Use SQLAlchemy session transactions to ensure consistency
- Rollback on any failure

**Integration with Existing Systems**:
- Leverage existing MaintenanceRequest and MaintenanceWork models
- Use existing ActivityLog system for audit trail
- Integrate with MachineDowntime system for automatic calculation
- Follow existing authorization patterns

### Project Structure Notes

All file locations align with the unified project structure defined in `docs/architecture.md#1057-1230`. Components follow the existing pattern from Story 4.3 for consistency.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

Claude Sonnet 4 (Auto)

### Debug Log References

No debug log entries required - all implementation completed successfully.

### Completion Notes List

1. **Backend Implementation Complete**: All API endpoints created with proper validation, authorization, and error handling
2. **Database Model Updated**: Added maintenanceSteps JSON field to MaintenanceWork model
3. **Progress Tracking Logic**: Implemented automatic timestamp tracking and status transitions
4. **Automatic Downtime Calculation**: Integrated with MachineDowntime system for accurate downtime tracking
5. **Frontend Components**: Created comprehensive UI components with tabbed interface for work progress management
6. **API Client Updated**: Enhanced with new progress tracking endpoints and proper TypeScript types
7. **Integration Complete**: Seamlessly integrated with existing maintenance request workflow
8. **Activity Logging**: Comprehensive audit trail for all work progress actions
9. **Manual Save Pattern**: Implemented user-preferred manual save button pattern for better UX
10. **Real-time Updates**: React Query integration for automatic cache invalidation and updates

### File List

**Backend Files Modified:**
- `backend/app/models/maintenance_work.py` - Added maintenanceSteps JSON field
- `backend/app/schemas/maintenance_work.py` - Added progress tracking schemas
- `backend/app/api/v1/endpoints/maintenance_work.py` - Added progress tracking endpoints

**Frontend Files Created:**
- `frontend/src/components/maintenance/MaintenanceWorkProgress.tsx` - Main progress component
- `frontend/src/components/maintenance/MaintenanceStepsList.tsx` - Steps tracking component  
- `frontend/src/components/maintenance/WorkCompletionForm.tsx` - Work completion form

**Frontend Files Modified:**
- `frontend/src/lib/api/maintenance-work.ts` - Updated API client with new endpoints
- `frontend/src/lib/types.ts` - Added MaintenanceStep and progress-related types
- `frontend/src/components/maintenance/WorkProgressForm.tsx` - Updated for new API structure
- `frontend/src/components/maintenance/RequestDetailModal.tsx` - Integrated new progress component

## QA Results

_This section will be populated by the QA agent after implementation review_
