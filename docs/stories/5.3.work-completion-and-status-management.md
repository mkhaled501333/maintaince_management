Status: Ready for Review

Done

As a maintenance technician,
I want to complete maintenance work and update request status,
so that the maintenance workflow is properly closed.

Acceptance Criteria

1. Work completion form captures all necessary information
2. Status is updated to COMPLETED when work is finished
3. Automatic downtime calculation is performed
4. All work documentation is properly saved
5. Completion notifications are sent to relevant stakeholders

Tasks / Subtasks

- [x] Backend: Add/confirm endpoint to complete work for a request (AC: 1-4)
  - [x] Accept payload: `workDescription`, final `maintenanceSteps`, `completedAt` (server default now), optional notes (AC: 1)
  - [x] Transition `MaintenanceRequest.status` to `COMPLETED` with validation rules (only from `IN_PROGRESS`/`WAITING_PARTS`) (AC: 2)
  - [x] Persist `MaintenanceWork.completedAt` and `workDescription` (AC: 1,4)
  - [x] Trigger automatic downtime calculation based on status transition and timestamps (AC: 3)
  - [x] Create `ActivityLog` entry for work completion (AC: 4)

- [x] Frontend: Implement "Complete Work" flow in technician UI (AC: 1-2,4)
  - [x] Add button and modal/section on `RequestDetail` to finalize work (AC: 1-2)
  - [x] Include fields: Work description, confirm steps complete, optional notes (AC: 1)
  - [x] Disable action unless request is `IN_PROGRESS` or `WAITING_PARTS` (AC: 2)
  - [x] On success, reflect status `COMPLETED` and show completion timestamp (AC: 2,4)

- [x] System behaviors (AC: 3-5)
  - [x] Invoke downtime auto-calc routine on completion; persist minutes and flags (AC: 3)
  - [x] Ensure attachments and work logs remain accessible post-completion (AC: 4)
  - [x] Hook notification mechanism (stub/log) upon completion to relevant roles (AC: 5)



Dev Notes

- Previous Story Insights
  - 5.1 introduced updating work progress and `maintenanceSteps`; this story finalizes the lifecycle by setting `completedAt` and transitioning status.

- Data Models
  - `MaintenanceRequest.status` supports `COMPLETED` and must transition from `IN_PROGRESS`/`WAITING_PARTS`. Includes relations to `MaintenanceWork` and `attachments` [Source: docs/architecture.md#Maintenance Request Model]
  - `MaintenanceWork` includes `workDescription`, `maintenanceSteps`, `startedAt`, `completedAt` [Source: docs/architecture.md#Maintenance Work Model]
  - `MachineDowntime` tracks downtime; auto-calculated flag should be set when computed by the system [Source: docs/architecture.md#MachineDowntime Model]
  - `ActivityLog` records completion with `action=COMPLETE` [Source: docs/architecture.md#ActivityLog Model]

- API Specifications
  - Backend style is REST via FastAPI; endpoints are organized under `backend/app/api/v1/` [Source: docs/architecture.md#Repository Structure]
  - Completion endpoint should: authenticate, authorize technician, validate current status, update `MaintenanceWork` and `MaintenanceRequest`, compute downtime, and log activity [Source: docs/architecture.md#Architectural Patterns]

- Component Specifications (Frontend)
  - Next.js App Router with React and React Query; add a technician action to finalize work within `RequestDetail` flow, respecting role-based access [Source: docs/architecture.md#Tech Stack]
  - Maintain optimistic UI only if consistent with server validation; otherwise rely on server response and refetch [Source: docs/architecture.md#Architectural Patterns]

- File Locations
  - Backend endpoints in `backend/app/api/v1/endpoints/maintenance_requests.py` or `maintenance_work.py`; services under `backend/app/services/` (downtime, audit) [Source: docs/architecture.md#Repository Structure]
  - Frontend UI in `frontend/src/components/maintenance/RequestDetailModal.tsx` and related API client in `frontend/src/lib/api/maintenance.ts` (or existing module) [Source: docs/architecture.md#Unified Project Structure]

- Technical Constraints
  - Use SQLAlchemy ORM for DB operations; maintain transactions when updating request status and related work to keep consistency [Source: docs/architecture.md#Tech Stack]
  - Activity logging is required for critical actions such as completion [Source: docs/architecture.md#Key Architectural Decisions Summary]


Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-29 | 0.1 | Initial Draft created from PRD and Architecture | Scrum Master |

Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (Auto)

### Debug Log References
- Updated complete endpoint validation to enforce request status transition rules
- Added optional notes field to completion schema and activity logging
- Enhanced notification stub with comprehensive logging
- Verified downtime calculation persists correctly with duration in hours

### Completion Notes List

1. **Backend Implementation:**
   - Enhanced `/maintenance-work/{work_id}/complete` endpoint with proper validation
   - Added optional `notes` field to `MaintenanceWorkComplete` schema
   - Implemented status transition validation: only allows completion from `IN_PROGRESS` or `WAITING_PARTS` request status
   - Automatic downtime calculation already existed and persists correctly
   - Activity log entries include completion notes when provided
   - Added notification stub/logging mechanism for future implementation

2. **Frontend Implementation:**
   - WorkCompletionForm already existed and properly integrated
   - Updated to send optional notes field in completion payload
   - Enhanced MaintenanceWorkProgress to show "Complete Work" tab only when request status is `IN_PROGRESS` or `WAITING_PARTS`
   - Added proper query invalidation to refresh request details after completion
   - Completion timestamp automatically displayed via RequestDetailModal's actualCompletionDate field

3. **System Behaviors:**
   - Downtime auto-calculation routine invokes on completion and persists duration
   - Attachments remain accessible post-completion (query enabled regardless of status)
   - Work logs remain accessible via MaintenanceWorkProgress component for completed work
   - Notification mechanism stubbed with comprehensive logging for stakeholders

4. **Key Features:**
   - Status validation prevents invalid transitions (only IN_PROGRESS/WAITING_PARTS â†’ COMPLETED)
   - Optional completion notes captured and included in activity logs
   - Automatic timestamp tracking for completion (endTime set automatically)
   - Real-time UI updates via React Query cache invalidation

### File List

**Backend Files Modified:**
- `backend/app/schemas/maintenance_work.py` - Added optional `notes` field to `MaintenanceWorkComplete` schema
- `backend/app/api/v1/endpoints/maintenance_work.py` - Enhanced complete endpoint with status validation, notes handling, and notification logging

**Frontend Files Modified:**
- `frontend/src/lib/api/maintenance-work.ts` - Added optional `notes` field to `MaintenanceWorkComplete` interface
- `frontend/src/components/maintenance/WorkCompletionForm.tsx` - Updated to send notes in completion payload
- `frontend/src/components/maintenance/MaintenanceWorkProgress.tsx` - Enhanced to show completion tab based on request status (IN_PROGRESS or WAITING_PARTS), added query invalidation for request details 

QA Results

- TBD

