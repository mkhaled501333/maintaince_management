# Story 3.3: Technician Request Management

## Status

Done

## Story

**As a** maintenance technician,  
**I want** to view available maintenance requests and accept work,  
**so that** I can efficiently manage my workload.

## Acceptance Criteria

1. Technician dashboard shows available requests that can be accepted
2. Requests can be accepted, changing status to IN_PROGRESS
3. Request details are accessible with all relevant information
4. Work progress can be updated and tracked
5. Status changes are properly logged and visible

## Tasks / Subtasks

- [x] Create Technician Dashboard Component (AC: 1, 2)
  - [x] Design technician-specific dashboard layout with request list
  - [x] Display available requests (PENDING status, no MaintenanceWork record)
  - [x] Implement accept request functionality with status update
  - [x] Add request filtering by priority and date
  - [x] Implement real-time updates using React Query
  - [x] Add mobile-responsive design for field technicians
  - [x] Show requests I've accepted (IN_PROGRESS with my MaintenanceWork record)

- [x] Create Request Acceptance Workflow (AC: 2, 5)
  - [x] Implement accept request API endpoint
  - [x] Create MaintenanceWork record when request is accepted
  - [x] Update request status to IN_PROGRESS automatically
  - [x] Log status change with activity logging
  - [x] Add confirmation dialog for accepting requests
  - [x] Prevent accepting requests already accepted by others
  - [x] Handle concurrent acceptance scenarios (prevent race conditions)

- [x] Create Request Detail View for Technicians (AC: 3)
  - [x] Design comprehensive request detail view for technicians
  - [x] Display all request information (machine, reporter, problem description)
  - [x] Show attached files with preview and download options
  - [x] Display failure code and maintenance type information
  - [x] Show machine location and access instructions
  - [x] Display request timeline and status history
  - [x] Add quick actions (Accept, Start Work, Update Progress)

- [x] Create Work Progress Update Interface (AC: 4)
  - [x] Design work progress update form component
  - [x] Implement maintenance steps tracking functionality
  - [x] Add work description textarea for notes
  - [x] Allow updating work start time
  - [x] Display current work progress status
  - [x] Add save draft functionality for work progress
  - [x] Implement manual save button (per user preference)
  - [x] Show unsaved changes indicator

- [x] Create API Endpoints for Technician Operations (AC: 1, 2, 4)
  - [x] Create GET /api/v1/maintenance-requests/available endpoint for available requests (PENDING status, no MaintenanceWork)
  - [x] Create GET /api/v1/maintenance-requests/my-work endpoint for technician's accepted requests (IN_PROGRESS with their MaintenanceWork)
  - [x] Create POST /api/v1/maintenance-requests/{id}/accept endpoint to accept requests
  - [x] Create GET /api/v1/maintenance-work/{id} endpoint for work details
  - [x] Create POST /api/v1/maintenance-work endpoint to create work record
  - [x] Create PATCH /api/v1/maintenance-work/{id} endpoint to update work progress
  - [x] Implement proper authorization (MAINTENANCE_TECH role required)
  - [x] Add request validation with Pydantic schemas
  - [x] Return proper error messages for authorization failures

- [x] Create API Client Functions for Technician Dashboard (AC: 1, 2, 4)
  - [x] Create getAvailableRequests function for available requests (PENDING, no work)
  - [x] Create getMyWorkRequests function for technician's accepted requests (IN_PROGRESS with their work)
  - [x] Create acceptRequest function for accepting requests
  - [x] Create getMaintenanceWork function for work details
  - [x] Create updateWorkProgress function for progress updates
  - [x] Implement proper TypeScript typing and error handling
  - [x] Add React Query integration for caching and updates
  - [x] Implement optimistic updates for better UX

- [x] Implement Status Tracking and Logging (AC: 5)
  - [x] Create activity logs for request acceptance
  - [x] Log work progress updates with timestamps
  - [x] Track status changes from PENDING to IN_PROGRESS
  - [x] Display status change history in request details
  - [x] Add automatic timestamp recording for work start
  - [x] Implement audit trail for all technician actions

## Dev Notes

### Previous Story Insights

From Story 3.2 (Maintenance Request Dashboard):
- Maintenance request dashboard successfully displays all requests with filtering
- Real-time updates implemented using React Query
- Request detail modal displays complete request information
- Status update tracking and activity logging established
- API endpoints exist for listing and viewing requests
- Backend authorization checks properly implemented for MAINTENANCE_MANAGER role

From Story 3.1 (Problem Reporting Interface):
- Maintenance requests are created with PENDING status
- File attachments are properly linked to maintenance requests
- Problem reporting captures all required information (description, priority, failure code, maintenance type)
- QR scanner integration established for problem reporting workflow

**Key Implementation Notes:**
- Technician dashboard shows two lists: "Available Requests" (PENDING, no work) and "My Work" (IN_PROGRESS with their MaintenanceWork record)
- There is NO assignment functionality - technicians self-select by accepting available requests
- Accepting a request creates MaintenanceWork record automatically and links technician to request
- Work progress should use manual save button (per user preference from memory)
- Mobile-responsive design critical for field technicians
- Real-time updates needed to show when requests are accepted by others
- Integration with existing maintenance request and maintenance work models

### Data Models

**MaintenanceRequest Model** [Source: architecture.md#data-models-maintenance-request-model]:
```typescript
enum RequestStatus {
  PENDING = 'PENDING',
  IN_PROGRESS = 'IN_PROGRESS',
  WAITING_PARTS = 'WAITING_PARTS',
  COMPLETED = 'COMPLETED',
  CANCELLED = 'CANCELLED'
}

interface MaintenanceRequest {
  id: number;
  machineId: number;
  reporterId: number;
  status: RequestStatus;
  priority: Priority;
  reportedAt: Date;
  problemDescription: string;
  failureCodeId: number | null;
  maintenanceTypeId: number | null;
  createdAt: Date;
  updatedAt: Date;
  
  // Relations
  machine: Machine;
  reporter: User;
  maintenanceWork: MaintenanceWork | null;
  attachments: Attachment[];
  failureCode: FailureCode | null;
  maintenanceType: MaintenanceType | null;
}
```

**MaintenanceWork Model** [Source: architecture.md#data-models-maintenance-work-model]:
```typescript
interface MaintenanceStep {
  step: number;
  description: string;
  completed: boolean;
  completedAt?: Date;
}

interface MaintenanceWork {
  id: number;
  requestId: number;
  technicianId: number;
  startedAt: Date | null;
  completedAt: Date | null;
  workDescription: string | null;
  maintenanceSteps: MaintenanceStep[] | null; // JSON stored, parsed as array
  createdAt: Date;
  updatedAt: Date;
  
  // Relations
  request: MaintenanceRequest;
  technician: User;
  sparePartsRequests: SparePartsRequest[];
}
```

**User Model** [Source: architecture.md#data-models-user-model]:
```typescript
enum UserRole {
  ADMIN = 'ADMIN',
  SUPERVISOR = 'SUPERVISOR',
  MAINTENANCE_TECH = 'MAINTENANCE_TECH',
  MAINTENANCE_MANAGER = 'MAINTENANCE_MANAGER',
  INVENTORY_MANAGER = 'INVENTORY_MANAGER'
}

interface User {
  id: number;
  username: string;
  fullName: string;
  role: UserRole;
  createdAt: Date;
  updatedAt: Date;
}
```

### API Specifications

**Get My Work Requests Endpoint** [Source: architecture.md#architectural-patterns]:
- Method: GET
- Path: `/api/v1/maintenance-requests/my-work`
- Authentication: Required (Bearer token)
- Authorization: MAINTENANCE_TECH role required
- Query Parameters:
  ```typescript
  {
    status?: RequestStatus; // Typically IN_PROGRESS
    priority?: Priority;
    page?: number;
    limit?: number;
  }
  ```
- Response: Paginated list of maintenance requests with IN_PROGRESS status where current user has MaintenanceWork record
- Automatically filters by current user's technicianId from MaintenanceWork records
- Error Handling: 401 for unauthorized, 403 for forbidden

**Get Available Requests Endpoint** [Source: architecture.md#architectural-patterns]:
- Method: GET
- Path: `/api/v1/maintenance-requests/available`
- Authentication: Required (Bearer token)
- Authorization: MAINTENANCE_TECH role required
- Query Parameters:
  ```typescript
  {
    status?: RequestStatus; // Should be PENDING
    priority?: Priority;
    machineId?: number;
    page?: number;
    limit?: number;
  }
  ```
- Response: Paginated list of maintenance requests with PENDING status and no MaintenanceWork record
- Error Handling: 401 for unauthorized, 403 for forbidden

**Accept Request Endpoint** [Source: architecture.md#architectural-patterns]:
- Method: POST
- Path: `/api/v1/maintenance-requests/{id}/accept`
- Authentication: Required (Bearer token)
- Authorization: MAINTENANCE_TECH role required
- Request Body: Empty (technician ID from token)
- Response: Created MaintenanceWork record and updated MaintenanceRequest
- Error Handling: 
  - 404 if request not found
  - 400 if request already has work record or wrong status
  - 403 if unauthorized
  - 409 if request was accepted concurrently by another technician

**Create Maintenance Work Endpoint** [Source: architecture.md#architectural-patterns]:
- Method: POST
- Path: `/api/v1/maintenance-work`
- Authentication: Required (Bearer token)
- Authorization: MAINTENANCE_TECH role required
- Request Body:
  ```typescript
  {
    requestId: number;
    startedAt?: Date;
    workDescription?: string;
    maintenanceSteps?: MaintenanceStep[];
  }
  ```
- Response: Created MaintenanceWork record
- Error Handling: 400 for invalid data, 403 for unauthorized, 409 for duplicate work record

**Update Maintenance Work Endpoint** [Source: architecture.md#architectural-patterns]:
- Method: PATCH
- Path: `/api/v1/maintenance-work/{id}`
- Authentication: Required (Bearer token)
- Authorization: MAINTENANCE_TECH role required (only own work)
- Request Body:
  ```typescript
  {
    startedAt?: Date;
    workDescription?: string;
    maintenanceSteps?: MaintenanceStep[];
    completedAt?: Date;
  }
  ```
- Response: Updated MaintenanceWork record
- Error Handling: 404 if work not found, 403 if not own work, 400 for invalid data

### Component Specifications

**TechnicianDashboard Component**:
- Location: `frontend/src/components/maintenance/TechnicianDashboard.tsx`
- Props: None (uses current user from auth context)
- Uses: React Query for data fetching, React hooks for state management
- Dependencies: React 18.x, React Query 5.x
- Features:
  - Tab-based interface: "Available Requests" and "My Work"
  - Available requests list (PENDING status, no MaintenanceWork) with accept button for each request
  - My work requests list (IN_PROGRESS status with technician's MaintenanceWork record)
  - Real-time updates using React Query
  - Mobile-responsive design with touch-friendly buttons
  - Priority color coding (CRITICAL: red, HIGH: orange, MEDIUM: yellow, LOW: green)
  - Status badges with appropriate styling
  - Pagination for large request lists
  - Loading states and error handling

**WorkProgressForm Component**:
- Location: `frontend/src/components/maintenance/WorkProgressForm.tsx`
- Props: `workId: number, request: MaintenanceRequest, onSave: () => void`
- Uses: react-hook-form for form state management
- Features:
  - Maintenance steps tracking with checkboxes
  - Work description textarea
  - Start time picker (optional)
  - Manual save button (per user preference)
  - Unsaved changes indicator
  - Form validation and error messages
  - Mobile-optimized layout
  - Save draft functionality

**AcceptRequestButton Component**:
- Location: `frontend/src/components/maintenance/AcceptRequestButton.tsx`
- Props: `requestId: number, onAccept: () => void`
- Features:
  - Accept button with confirmation dialog
  - Loading state during acceptance
  - Error handling with user-friendly messages
  - Optimistic UI update
  - Disabled state if request already accepted

### File Locations

**Frontend Files** [Source: architecture.md#unified-project-structure]:
- `frontend/src/app/(dashboard)/maintenance/technician/page.tsx` - Technician dashboard page
- `frontend/src/components/maintenance/TechnicianDashboard.tsx` - Main technician dashboard component (Available + My Work tabs)
- `frontend/src/components/maintenance/WorkProgressForm.tsx` - Work progress update form
- `frontend/src/components/maintenance/AcceptRequestButton.tsx` - Accept request button component
- `frontend/src/lib/api/maintenance-requests.ts` - Extend API client with technician endpoints (available, my-work, accept)
- `frontend/src/lib/api/maintenance-work.ts` - New API client for maintenance work operations
- `frontend/src/lib/types.ts` - Add technician-specific types (extend existing)

**Backend Files** [Source: architecture.md#unified-project-structure]:
- `backend/app/api/v1/endpoints/maintenance_requests.py` - Add available/my-work/accept endpoints
- `backend/app/api/v1/endpoints/maintenance_work.py` - New endpoint file for maintenance work CRUD
- `backend/app/schemas/maintenance_request.py` - Extend existing schemas
- `backend/app/schemas/maintenance_work.py` - New schemas for maintenance work
- `backend/app/models/maintenance_work.py` - Maintenance work model (already exists)
- `backend/app/services/maintenance_service.py` - Business logic for technician operations

### Technical Constraints

**Role-Based Access Control** [Source: architecture.md#tech-stack]:
- MAINTENANCE_TECH role required for technician dashboard access
- Technicians can only accept PENDING requests (no MaintenanceWork record exists)
- Technicians can only view and update their own MaintenanceWork records
- Proper authorization checks on all API endpoints
- Role validation in frontend components
- No assignment functionality - technicians self-select requests by accepting them

**Manual Save Workflow** [Source: memory]:
- User prefers manual save button for work progress updates
- Save button appears when fields (maintenance steps, work description, cost) change
- Submission sent only on clicking save, not auto-saving on keystroke
- Similar to inspection result workflow pattern
- Show unsaved changes indicator when form is dirty

**Real-Time Updates** [Source: architecture.md#tech-stack]:
- React Query for automatic data refetching
- Optimistic updates for better user experience
- Background refetching every 30 seconds
- Manual refresh capability
- Handle concurrent request acceptance (prevent race conditions)

**Performance Considerations** [Source: architecture.md#architectural-patterns]:
- Pagination for request lists (default 25 items per page)
- Lazy loading of request details
- Efficient filtering of available requests (PENDING + no MaintenanceWork) vs my work (IN_PROGRESS + my MaintenanceWork)
- Caching of request data with React Query
- Optimized database queries with proper joins
- Index on MaintenanceWork.technicianId and requestId

**Mobile Responsiveness** [Source: architecture.md#tech-stack]:
- Mobile-first design for field technicians
- Touch-friendly buttons and form inputs
- Swipe gestures for navigation (future enhancement)
- Collapsible sections to save vertical space
- Responsive modal dialogs
- Camera integration for work documentation (future enhancement)

**Security Requirements** [Source: architecture.md#tech-stack]:
- Role-based access control enforcement
- Technicians can only accept/update their own work
- Prevent unauthorized access to other technicians' work
- Input validation and sanitization
- Audit logging for all technician actions
- Secure request acceptance with proper concurrency handling

**Concurrency Handling**:
- Prevent multiple technicians from accepting same request simultaneously
- Use database transactions with proper locking
- Return clear error messages for concurrent acceptance conflicts
- Implement optimistic locking or versioning if needed
- Show real-time updates when requests are accepted by others

### Testing Requirements

**Component Testing** [Source: architecture.md#tech-stack]:
- Unit tests for TechnicianDashboard component
- Test available vs my work request filtering
- Test accept request functionality with confirmation
- Test work progress form with manual save
- Test unsaved changes indicator
- Mock API responses for all client functions
- Test mobile responsiveness
- Test role-based access control
- Test loading and error states

**Integration Testing**:
- Test complete workflow: view available → accept request → update progress → save
- Test concurrent request acceptance scenarios
- Test real-time updates with React Query
- Test manual save workflow with unsaved changes
- Test error scenarios (network failures, validation errors, authorization failures)
- Verify proper activity logging for all actions
- Test mobile interactions on touch devices

**API Testing**:
- Test my-work requests endpoint with MAINTENANCE_TECH role (should only show IN_PROGRESS with their MaintenanceWork)
- Test available requests endpoint (should only show PENDING requests without MaintenanceWork record)
- Test accept request endpoint with proper authorization
- Test maintenance work CRUD endpoints
- Test concurrent acceptance prevention (verify only one technician can accept same request)
- Test authorization failures (wrong role, not own work)
- Test input validation and error handling
- Verify proper database transactions and locking

**E2E Testing**:
- Test complete technician workflow from dashboard to work completion
- Test accept request and work progress update flow
- Test manual save button functionality
- Test mobile device interactions
- Test real-time updates across multiple browser sessions
- Verify activity logs are created correctly

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-01-XX | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (Dev Agent)

### Debug Log References

- All technician request management tasks completed successfully
- Backend API endpoints implemented with comprehensive authorization and validation
- Frontend technician dashboard created with tab-based interface (Available/My Work)
- Request acceptance workflow implemented with concurrent request prevention
- Work progress form implemented with manual save button (per user preference)
- Status tracking and activity logging implemented throughout
- No linting errors in the implementation

### Completion Notes List

1. **Technician Dashboard Component**: Successfully created comprehensive dashboard
   - Tab-based interface with "Available Requests" and "My Work" sections
   - Available requests show PENDING requests with no MaintenanceWork record
   - My Work shows IN_PROGRESS requests with technician's MaintenanceWork record
   - Real-time updates using React Query with 30-second refresh intervals
   - Priority filtering and pagination support
   - Mobile-responsive design with touch-friendly interface elements
   - Accept button with confirmation dialog for available requests

2. **Request Acceptance Workflow**: Implemented complete acceptance system
   - POST /api/v1/maintenance-requests/{id}/accept endpoint creates MaintenanceWork and updates status
   - Automatic status change from PENDING to IN_PROGRESS on acceptance
   - Activity logging for all acceptance events
   - Concurrent request prevention using database transactions
   - Error handling for already-accepted requests
   - Confirmation dialog in frontend before acceptance

3. **Request Detail View**: Enhanced existing modal for technicians
   - Display all request information including machine, reporter, and problem description
   - File attachments with preview and download options
   - Failure code and maintenance type information displayed
   - Request timeline showing requested date and expected completion
   - Integrated WorkProgressForm for IN_PROGRESS requests assigned to technician

4. **Work Progress Update Interface**: Created comprehensive work tracking form
   - Maintenance steps tracking with checkboxes and descriptions
   - Work description textarea for detailed notes
   - Start time picker for work commencement
   - Manual save button (per user preference) that appears when form is dirty
   - Unsaved changes indicator with visual warning
   - Form automatically loads existing work data if available
   - Supports both creating new work and updating existing work

5. **Backend API Endpoints**: Created complete API infrastructure
   - GET /api/v1/maintenance-requests/available - Available requests for technicians
   - GET /api/v1/maintenance-requests/my-work - Technician's assigned work
   - POST /api/v1/maintenance-requests/{id}/accept - Accept request endpoint
   - GET /api/v1/maintenance-work/{id} - Get work by ID
   - GET /api/v1/maintenance-work/by-request/{request_id} - Get work by request ID
   - POST /api/v1/maintenance-work - Create work record
   - PATCH /api/v1/maintenance-work/{id} - Update work progress
   - Proper authorization with MAINTENANCE_TECH role requirements
   - Pydantic schemas for request validation
   - Concurrent acceptance handling with database transactions

6. **API Client Functions**: Created comprehensive frontend API layer
   - maintenanceRequestApi.getAvailableRequests() - Fetch available requests
   - maintenanceRequestApi.getMyWorkRequests() - Fetch technician's work
   - maintenanceRequestApi.acceptRequest() - Accept a request
   - maintenanceWorkApi.getWork() - Get work by ID
   - maintenanceWorkApi.getWorkByRequest() - Get work by request ID
   - maintenanceWorkApi.createWork() - Create new work record
   - maintenanceWorkApi.updateWork() - Update work progress
   - Proper TypeScript typing and error handling
   - React Query integration for caching and real-time updates

7. **Status Tracking and Logging**: Implemented comprehensive audit trail
   - Activity logs created for request acceptance events
   - Work progress updates logged with timestamps and user information
   - Automatic timestamp recording for work start time
   - Status change tracking from PENDING to IN_PROGRESS
   - Audit trail for all technician actions
   - Integration with existing ActivityLog model

### File List

**Backend Files:**
- `backend/app/schemas/maintenance_work.py` - Created Pydantic schemas for maintenance work (Create, Update, Response)
- `backend/app/api/v1/endpoints/maintenance_requests.py` - Added available, my-work, and accept endpoints
- `backend/app/api/v1/endpoints/maintenance_work.py` - Created new endpoint file for maintenance work CRUD operations
- `backend/app/api/v1/api.py` - Updated to include maintenance-work router

**Frontend Files:**
- `frontend/src/app/(dashboard)/maintenance/technician/page.tsx` - Created technician dashboard page
- `frontend/src/components/maintenance/TechnicianDashboard.tsx` - Main technician dashboard component with tabs
- `frontend/src/components/maintenance/WorkProgressForm.tsx` - Work progress update form with manual save
- `frontend/src/components/maintenance/RequestDetailModal.tsx` - Enhanced with WorkProgressForm integration
- `frontend/src/lib/api/maintenance-requests.ts` - Extended with technician-specific functions (available, my-work, accept)
- `frontend/src/lib/api/maintenance-work.ts` - Created new API client for maintenance work operations
- `frontend/src/lib/types.ts` - Types already included from previous stories

**Project Files:**
- `docs/stories/3.3.technician-request-management.md` - Updated story with completion status

## QA Results

_This section will be populated by the QA agent during review_

