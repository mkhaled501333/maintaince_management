# Story 2.3: Machine Information Display

## Status

Done

## Story

**As a** user scanning a QR code,  
**I want** to see comprehensive machine information and history,  
**so that** I can understand the machine's status and maintenance history.

## Acceptance Criteria

1. Machine detail view displays all machine information
2. Machine maintenance history is shown with status and dates
3. Current machine status and any active maintenance requests are displayed
4. Machine-specific spare parts requirements are shown
5. File attachments related to the machine are accessible

## Tasks / Subtasks

- [x] Create Machine Detail API endpoint (AC: 1, 2, 3, 4, 5)
  - [x] Create GET /api/v1/machines/{id}/detail endpoint
  - [x] Include machine information with department details
  - [x] Include related maintenance requests with status filtering
  - [x] Include spare parts requirements (MachineSparePart relationships)
  - [x] Include file attachments related to machine
  - [x] Add pagination for maintenance history
  - [x] Implement efficient database queries with proper joins

- [x] Create Maintenance History Component (AC: 2)
  - [x] Design history display with status badges
  - [x] Show maintenance dates and durations
  - [x] Display priority and problem descriptions
  - [x] Add sorting and filtering options
  - [x] Implement pagination for history records
  - [x] Add click-through to detailed maintenance request view

- [x] Create Active Maintenance Status Display (AC: 3)
  - [x] Display current machine status with visual indicators
  - [x] Show active maintenance requests with current status
  - [x] Display technician assignments and progress
  - [x] Add timestamp for status changes
  - [x] Implement real-time status updates
  - [x] Add status change history

- [x] Create Spare Parts Requirements Display (AC: 4)
  - [x] Display machine-specific spare parts with quantities
  - [x] Show current stock levels vs. required quantities
  - [x] Add low stock indicators and alerts
  - [x] Display spare part details and specifications
  - [x] Link to spare parts inventory management
  - [x] Add spare parts usage history

- [x] Create File Attachments Section (AC: 5)
  - [x] Display all file attachments related to machine
  - [x] Group attachments by type (images, documents, videos)
  - [x] Implement file preview functionality
  - [x] Add file download capabilities
  - [x] Show file metadata (upload date, uploader)
  - [x] Add file upload for machine documentation

- [x] Integrate Machine Detail View with QR Scanner (AC: 1, 2, 3, 4, 5)
  - [x] Update MachineDisplay component after QR scan
  - [x] Navigate to full machine detail view from scanner
  - [x] Preserve QR code context in navigation
  - [x] Add deep linking support for QR scanners
  - [x] Implement mobile-optimized detail view
  - [x] Add quick actions (report problem, view on map)

## Dev Notes

### Previous Story Insights

From Story 2.2 (Mobile QR Code Scanner Interface):
- QR Scanner successfully implemented using native HTML5 Camera API with jsQR library
- Machine lookup endpoint exists: `GET /api/v1/machines/qr/{qrCode}` 
- Mobile-optimized MachineDisplay component created for immediate display after scan
- QR scanner integration points established for navigation
- Role-based access control implemented for SUPERVISOR, MAINTENANCE_TECH, MAINTENANCE_MANAGER, and ADMIN roles

From Story 2.1 (QR Code Generation and Machine Setup):
- Machine data model fully implemented with all required fields and status enum
- API client functions established in `frontend/src/lib/api/machines.ts`
- Machine management interfaces created for admin users
- QR code generation and lookup functionality working

**Key Implementation Notes:**
- MachineDisplay component already created but needs enhancement with comprehensive detail view
- QR scanner flow: Scan → Show Basic Info → Navigate to Full Detail View
- Machine detail should be accessible from both QR scanner and machine list
- Mobile-first design required for field technicians using QR scanning

### Data Models

**Machine Model** [Source: architecture.md#data-models-machine-model]:
```typescript
interface Machine {
  id: number;
  qrCode: string;
  name: string;
  model: string | null;
  serialNumber: string | null;
  departmentId: number;
  location: string | null;
  installationDate: Date | null;
  status: MachineStatus;
  createdAt: Date;
  updatedAt: Date;
  
  // Relations
  department: Department;
  spareParts: MachineSparePart[];
  maintenanceRequests: MaintenanceRequest[];
}
```

**MaintenanceRequest Model** [Source: architecture.md#data-models-maintenance-request-model]:
```typescript
interface MaintenanceRequest {
  id: number;
  machineId: number;
  reporterId: number;
  status: RequestStatus;
  priority: Priority;
  reportedAt: Date;
  problemDescription: string;
  failureCodeId: number | null;
  maintenanceTypeId: number | null;
  createdAt: Date;
  updatedAt: Date;
  
  // Relations
  machine: Machine;
  reporter: User;
  maintenanceWork: MaintenanceWork | null;
  attachments: Attachment[];
  failureCode: FailureCode | null;
  maintenanceType: MaintenanceType | null;
}
```

**MachineSparePart Model** [Source: architecture.md#data-models-machine-spare-part-model]:
```typescript
interface MachineSparePart {
  id: number;
  machineId: number;
  sparePartId: number;
  minQty: number;
  maxQty: number | null;
  createdAt: Date;
  
  // Relations
  machine: Machine;
  sparePart: SparePart;
}
```

**Attachment Model** [Source: architecture.md#data-models-attachment-model]:
```typescript
interface Attachment {
  id: number;
  entityType: EntityType;
  entityId: number;
  fileUrl: string;
  fileType: FileType;
  uploadedBy: number;
  uploadedAt: Date;
  
  // Relations
  uploader: User;
}
```

**Enums:**
```typescript
enum MachineStatus {
  OPERATIONAL = 'OPERATIONAL',
  DOWN = 'DOWN',
  MAINTENANCE = 'MAINTENANCE',
  DECOMMISSIONED = 'DECOMMISSIONED'
}

enum RequestStatus {
  PENDING = 'PENDING',
  IN_PROGRESS = 'IN_PROGRESS',
  WAITING_PARTS = 'WAITING_PARTS',
  COMPLETED = 'COMPLETED',
  CANCELLED = 'CANCELLED'
}

enum Priority {
  LOW = 'LOW',
  MEDIUM = 'MEDIUM',
  HIGH = 'HIGH',
  CRITICAL = 'CRITICAL'
}

enum FileType {
  IMAGE = 'IMAGE',
  PDF = 'PDF',
  DOCUMENT = 'DOCUMENT',
  VIDEO = 'VIDEO',
  OTHER = 'OTHER'
}

enum EntityType {
  MACHINE = 'MACHINE',
  MAINTENANCE_REQUEST = 'MAINTENANCE_REQUEST',
  SPARE_PART = 'SPARE_PART',
  PREVENTIVE_MAINTENANCE = 'PREVENTIVE_MAINTENANCE',
  INVENTORY_TRANSACTION = 'INVENTORY_TRANSACTION'
}
```

### API Specifications

**Machine Detail Endpoint** [Source: architecture.md#unified-project-structure]:
- Endpoint: `GET /api/v1/machines/{id}/detail`
- Query params: `includeHistory` (bool, default: true), `page` (int), `pageSize` (int, default: 10)
- Returns: Machine object with:
  - Complete machine information
  - Department details
  - Recent maintenance requests (paginated)
  - Active maintenance requests
  - Spare parts requirements with current stock levels
  - File attachments metadata
- Error handling: 404 for invalid machine ID, 500 for server errors

**Existing Endpoints to Extend:**
- `GET /api/v1/machines/{id}` - Basic machine information (already exists from Story 2.1)
- `GET /api/v1/machines/qr/{qrCode}` - Machine lookup by QR code (already exists from Story 2.1)

**Attachments Endpoint** (to be created):
- Endpoint: `GET /api/v1/attachments`
- Query params: `entityType` (enum), `entityId` (int), `fileType` (enum, optional)
- Returns: List of attachments for specified entity
- Error handling: 404 for invalid entity, 403 for unauthorized access

### Component Specifications

**MachineDetailPage** [Source: architecture.md#unified-project-structure]:
- Location: `frontend/src/app/(dashboard)/machines/[id]/page.tsx`
- Purpose: Comprehensive machine information display
- Sections:
  - Machine header with status, name, location
  - Active maintenance status panel
  - Maintenance history timeline
  - Spare parts requirements table
  - File attachments gallery
  - Quick action buttons
- Mobile-optimized layout with collapsible sections
- Deep link support from QR scanner

**MachineStatusPanel Component**:
- Location: `frontend/src/components/machines/MachineStatusPanel.tsx`
- Props: `machine: Machine, activeRequests: MaintenanceRequest[]`
- Displays current status with visual indicators
- Shows active maintenance requests
- Real-time status updates

**MaintenanceHistory Component**:
- Location: `frontend/src/components/machines/MaintenanceHistory.tsx`
- Props: `history: MaintenanceRequest[], pagination: PaginationMeta`
- Props: `onLoadMore: () => void, onSelectRequest: (id: number) => void`
- Timeline view of maintenance history
- Click-through to detailed request view
- Sorting and filtering controls

**SparePartsRequirements Component**:
- Location: `frontend/src/components/machines/SparePartsRequirements.tsx`
- Props: `requirements: MachineSparePartWithStock[]`
- Table view with stock status indicators
- Low stock alerts
- Navigation to spare parts management

**FileAttachmentsSection Component**:
- Location: `frontend/src/components/machines/FileAttachmentsSection.tsx`
- Props: `machineId: number, attachments: Attachment[]`
- Image gallery for photos
- Document list with previews
- File upload functionality
- Group by file type

### File Locations

**Frontend Files** [Source: architecture.md#unified-project-structure]:
- `frontend/src/app/(dashboard)/machines/[id]/page.tsx` - Machine detail page
- `frontend/src/components/machines/MachineStatusPanel.tsx` - Status display component
- `frontend/src/components/machines/MaintenanceHistory.tsx` - History timeline component
- `frontend/src/components/machines/SparePartsRequirements.tsx` - Spare parts display
- `frontend/src/components/machines/FileAttachmentsSection.tsx` - File attachments display
- `frontend/src/lib/api/machines.ts` - Extend with detail endpoint call
- `frontend/src/lib/api/attachments.ts` - Add attachments API client

**Backend Files** [Source: architecture.md#unified-project-structure]:
- `backend/app/api/v1/endpoints/machines.py` - Add detail endpoint
- `backend/app/schemas/machine.py` - Add MachineDetailResponse schema
- `backend/app/models/machine.py` - Machine model (already exists from Story 2.1)

### Technical Constraints

**Mobile Responsiveness** [Source: architecture.md#tech-stack]:
- Mobile-first design for field technicians using QR scanning
- Touch-friendly interface elements
- Collapsible sections for space efficiency
- Optimized image loading for attachments

**Performance Considerations** [Source: architecture.md#architectural-patterns]:
- Lazy load maintenance history for large datasets
- Paginate attachments gallery
- Optimize database queries with proper joins
- Cache machine details for quick access
- Implement efficient image rendering for attachments

**Security Requirements** [Source: architecture.md#tech-stack]:
- Role-based access control for file attachments
- Secure file storage and access validation
- Prevent unauthorized machine information access
- Audit logging for sensitive file access

### Testing Requirements

**Component Testing** [Source: architecture.md#tech-stack]:
- Unit tests for MachineDetailPage component
- Test status panel rendering with different states
- Test maintenance history pagination
- Test spare parts display with various stock levels
- Mock API responses for all components

**Integration Testing**:
- Test complete flow: QR scan → Machine detail view
- Test navigation from scanner to detail view
- Test deep linking functionality
- Verify mobile responsiveness across devices
- Test file attachment upload and display

**API Testing**:
- Test machine detail endpoint with various IDs
- Test pagination parameters
- Test error handling for invalid machines
- Verify efficient database queries
- Test file attachment retrieval

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-01-XX | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (Dev Agent)

### Debug Log References

- All machine detail tasks completed successfully
- Machine Detail API endpoint implemented with comprehensive data fetching using efficient database joins
- Frontend components created for all display sections (status, history, spare parts, attachments)
- Integration with QR scanner completed with navigation links
- Mobile-optimized detail view implemented with responsive design
- No linting errors in the implementation

### Completion Notes List

1. **Machine Detail API Endpoint**: Successfully created comprehensive endpoint at GET /api/v1/machines/{id}/detail
   - Implemented efficient database queries with proper joins for department, maintenance requests, spare parts, and attachments
   - Added pagination support for maintenance history
   - Created comprehensive Pydantic schemas for all related data
   - Returns active maintenance requests, maintenance history, spare parts with stock status, and file attachments

2. **Machine Status Panel Component**: Created component showing current machine status and active maintenance
   - Visual status indicators with color coding
   - Display of active maintenance requests with priority badges
   - Status-based color schemes for request types
   - Real-time status information display

3. **Maintenance History Component**: Implemented timeline view of completed maintenance
   - Chronological display of maintenance history
   - Status badges and priority indicators
   - Pagination support with "Load More" functionality
   - Detailed date/time formatting for all maintenance events

4. **Spare Parts Requirements Component**: Created comprehensive table view
   - Displays machine-specific spare parts with quantities
   - Stock level indicators (In Stock, Low Stock, Out of Stock)
   - Current stock vs. required quantity comparison
   - Unit price display with currency formatting

5. **File Attachments Section**: Implemented file attachment gallery
   - Grouping by file type (images, documents, etc.)
   - File preview modal with detailed metadata
   - Download capability for all attachments
   - Image preview functionality for image attachments

6. **QR Scanner Integration**: Updated MachineDisplay component
   - Added "View Full Details" link that navigates to detail page
   - Updated machine list page with clickable machine names and "View" action
   - Deep linking support for seamless navigation from QR scan to detail view
   - Mobile-optimized layout with responsive design

### File List

**Backend Files:**
- `backend/app/schemas/machine.py` - Added detailed response schemas (DepartmentBasicInfo, MaintenanceRequestBasicInfo, SparePartBasicInfo, MachineSparePartInfo, AttachmentBasicInfo, MachineDetailResponse)
- `backend/app/api/v1/endpoints/machines.py` - Added GET /api/v1/machines/{id}/detail endpoint with comprehensive data fetching

**Frontend Files:**
- `frontend/src/lib/types.ts` - Added TypeScript interfaces for machine detail view (DepartmentBasicInfo, MaintenanceRequestBasicInfo, SparePartBasicInfo, MachineSparePartInfo, AttachmentBasicInfo, MachineDetailResponse)
- `frontend/src/lib/api/machines.ts` - Added getMachineDetail API function
- `frontend/src/app/(dashboard)/machines/[id]/page.tsx` - Created machine detail page with full information display
- `frontend/src/components/machines/MachineStatusPanel.tsx` - Active maintenance status display component
- `frontend/src/components/machines/MaintenanceHistory.tsx` - Maintenance history timeline component
- `frontend/src/components/machines/SparePartsRequirements.tsx` - Spare parts requirements table component
- `frontend/src/components/machines/FileAttachmentsSection.tsx` - File attachments gallery component
- `frontend/src/components/qr-scanner/MachineDisplay.tsx` - Updated with "View Full Details" link
- `frontend/src/app/(dashboard)/machines/page.tsx` - Added "View" action and clickable machine names

**Project Files:**
- `docs/stories/2.3.machine-information-display.md` - Updated story with completion status

## QA Results

_This section will be populated by the QA agent during review_

