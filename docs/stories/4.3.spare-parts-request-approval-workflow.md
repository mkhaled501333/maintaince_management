# Story 4.3: Spare Parts Request and Approval Workflow

## Status

Done


## Story

**As a** maintenance technician,  
**I want** to request spare parts during maintenance work,  
**so that** I can complete maintenance tasks efficiently.

## Acceptance Criteria

1. Spare parts requests can be created during maintenance work
2. Requests are routed to maintenance managers for approval
3. Approved requests are sent to inventory managers for issuing
4. Issued parts are automatically deducted from inventory
5. Usage is tracked and linked to specific maintenance requests

## Tasks / Subtasks

- [x] Create Spare Parts Request API Endpoints (AC: 1, 2, 3, 4)
  - [x] Create GET /api/v1/spare-parts-requests endpoint for listing requests with pagination and filtering
  - [x] Create GET /api/v1/spare-parts-requests/{id} endpoint for retrieving single request details
  - [x] Create POST /api/v1/spare-parts-requests endpoint for creating new requests (technicians)
  - [x] Create PATCH /api/v1/spare-parts-requests/{id}/approve endpoint for approving requests (maintenance managers)
  - [x] Create PATCH /api/v1/spare-parts-requests/{id}/reject endpoint for rejecting requests (maintenance managers)
  - [x] Create PATCH /api/v1/spare-parts-requests/{id}/issue endpoint for issuing parts (inventory managers)
  - [x] Implement filtering by status, maintenanceWorkId, sparePartId, and requestedBy
  - [x] Add proper authorization (MAINTENANCE_TECH for create, MAINTENANCE_MANAGER for approve/reject, INVENTORY_MANAGER for issue)
  - [x] Validate maintenanceWorkId exists and belongs to current technician
  - [x] Validate sparePartId exists and has sufficient stock when requesting

- [x] Create Spare Parts Request Schemas (AC: 1, 2, 3)
  - [x] Create SparePartsRequestCreate schema with validation (maintenanceWorkId, sparePartId, quantityRequested)
  - [x] Create SparePartsRequestResponse schema with full details including related entities
  - [x] Create SparePartsRequestListResponse schema with pagination
  - [x] Create ApproveRequest schema for approval notes/reason
  - [x] Create RejectRequest schema for rejection reason
  - [x] Validate quantityRequested is positive
  - [x] Validate maintenanceWorkId exists and status allows parts request
  - [x] Validate sparePartId exists and is active

- [x] Implement Request Approval Workflow (AC: 2, 3)
  - [x] Auto-route requests to maintenance managers when created
  - [x] Update request status to APPROVED when manager approves
  - [x] Update request status to REJECTED when manager rejects
  - [x] Auto-route approved requests to inventory managers
  - [x] Track approval/rejection timestamp and approver user ID
  - [x] Create activity log entries for approval/rejection actions
  - [x] Update maintenance request status to WAITING_PARTS when parts are requested

- [x] Implement Parts Issuance and Inventory Deduction (AC: 4)
  - [x] Allow inventory managers to issue approved parts
  - [x] Update request status to ISSUED when parts are issued
  - [x] Automatically create inventory transaction (OUT type) when parts are issued
  - [x] Link inventory transaction to spare parts request via referenceType and referenceId
  - [x] Automatically deduct quantity from SparePart currentStock
  - [x] Validate sufficient stock exists before issuing
  - [x] Create activity log entry for issuance

- [x] Create Spare Parts Request Frontend Components (AC: 1, 2, 3)
  - [x] Create SparePartsRequestForm component for technicians to request parts
  - [x] Create SparePartsRequestsList component with filtering by status
  - [x] Create RequestApproval component for maintenance managers to approve/reject
  - [x] Create PartsIssuance component for inventory managers to issue parts
  - [x] Add request creation UI in maintenance work detail view
  - [x] Display current stock levels and warnings for low stock
  - [x] Show request status and workflow progression visually

- [x] Create Frontend API Client for Spare Parts Requests (AC: 1, 2, 3, 4)
  - [x] Create spare-parts-requests.ts API client with all CRUD operations
  - [x] Implement createSparePartsRequest function
  - [x] Implement approveRequest function
  - [x] Implement rejectRequest function
  - [x] Implement issueRequest function
  - [x] Add React Query hooks for data fetching and caching
  - [x] Implement optimistic updates for better UX

- [x] Add Integration with Maintenance Work and Inventory (AC: 1, 4, 5)
  - [x] Add spare parts requests section to maintenance work detail view
  - [x] Show pending/approved/issued requests on maintenance work
  - [x] Link issued parts to maintenance request for tracking
  - [x] Update maintenance request status when parts are requested
  - [x] Clear integration with inventory transaction system
  - [x] Show parts usage history in maintenance request details

- [x] Implement Activity Logging (AC: 5)
  - [x] Log CREATE action when requests are created
  - [x] Log APPROVE action when requests are approved
  - [x] Log REJECT action when requests are rejected
  - [x] Log ISSUE action when parts are issued
  - [x] Include request details, quantities, and approver information in logs

## Dev Notes

### Previous Story Insights

From Story 4.2 (Inventory Transaction System):
- Manual save button pattern: Form fields should show a save button when changed, submission only on button click [Source: User Memory ID: 2868641]
- Real-time updates: Use React Query with automatic refetch after mutation
- Database transactions: Use SQLAlchemy session transactions for atomicity
- Stock validation: Check quantity before processing OUT transactions
- Activity logging: Include before/after values and details in activity logs

### Data Models

**SparePartsRequest Model** [Source: architecture.md#505-555]:
- Fields: `id`, `maintenanceWorkId`, `sparePartId`, `quantityRequested`, `status`, `requestedBy`, `approvedBy`, `approvedAt`, `createdAt`, `updatedAt`
- Status enum: PENDING, APPROVED, REJECTED, ISSUED
- Relationships:
  - Belongs to MaintenanceWork (many-to-one) - requests are associated with a work record
  - Belongs to SparePart (many-to-one) - specifies which part is requested
  - Belongs to User as requester (many-to-one) - technician who requested
  - Belongs to User as approver (many-to-one, nullable) - manager who approved/rejected
  - Has one SparePartsUsage (one-to-one, nullable) - tracks actual usage after issuing

**MaintenanceWork Relationship** [Source: architecture.md#410-454]:
- MaintenanceWork has many SparePartsRequests (one-to-many)
- MaintenanceWork belongs to MaintenanceRequest (one-to-one)
- MaintenanceWork status can be IN_PROGRESS, COMPLETED, ON_HOLD, CANCELLED

**SparePart Model** [Source: architecture.md#457-502]:
- Fields include: `id`, `partNumber`, `partName`, `quantity` (currentStock), `minQuantity`, `unitPrice`, `location`
- SparePart has many SparePartsRequests (one-to-many)

**InventoryTransaction Integration** [Source: architecture.md#558-612]:
- When parts are issued, create InventoryTransaction with:
  - transactionType: OUT
  - referenceType: MAINTENANCE
  - referenceId: sparePartsRequestId or maintenanceRequestId
  - Automatic quantity deduction handled by inventory transaction system

### API Specifications

**Endpoints to Create** [Source: .d/TECHNICAL_ARCHITECTURE.md#404-416]:
```
GET    /api/v1/spare-parts-requests              # List all requests
GET    /api/v1/spare-parts-requests/{id}         # Get request details
POST   /api/v1/spare-parts-requests              # Create request
PATCH  /api/v1/spare-parts-requests/{id}/approve # Approve request
PATCH  /api/v1/spare-parts-requests/{id}/reject  # Reject request
PATCH  /api/v1/spare-parts-requests/{id}/issue   # Issue parts
GET    /api/v1/spare-parts-requests/pending-approval  # Pending approvals
GET    /api/v1/spare-parts-requests/approved     # Approved requests to issue
```

**Authorization Requirements** [Source: Previous stories pattern]:
- CREATE: MAINTENANCE_TECH or ADMIN role required
- APPROVE/REJECT: MAINTENANCE_MANAGER or ADMIN role required
- ISSUE: INVENTORY_MANAGER or ADMIN role required
- VIEW: All authenticated users can view, filtered by their role

**Request Validation**:
- maintenanceWorkId must exist and belong to an active maintenance work record
- sparePartId must exist and be active
- quantityRequested must be positive
- For APPROVE action: request must be in PENDING status
- For ISSUE action: request must be in APPROVED status and stock must be sufficient

### Component Specifications

**Backend File Locations** [Source: architecture.md#1057-1230]:
- Model: `backend/app/models/spare_parts_request.py`
- Schema: `backend/app/schemas/spare_parts_request.py`
- API Endpoints: `backend/app/api/v1/endpoints/spare_parts_requests.py`
- Router registration: `backend/app/api/v1/api.py`

**Frontend File Locations** [Source: architecture.md#1057-1230]:
- API Client: `frontend/src/lib/api/spare-parts-requests.ts`
- Components: `frontend/src/components/maintenance/SparePartsRequestForm.tsx`, `SparePartsRequestsList.tsx`, `RequestApproval.tsx`, `PartsIssuance.tsx`
- Types: `frontend/src/lib/types.ts` (add SparePartsRequest interfaces)
- Page/Route: Integrate into existing maintenance work pages

**Component Patterns** [Source: Story 4.2]:
- Use React Query for data fetching with useQuery and useMutation hooks
- Manual save button pattern: Show save button when form fields change
- Optimistic updates for better UX
- Real-time updates with automatic cache invalidation

### File Locations

**Backend Files to Create**:
- `backend/app/models/spare_parts_request.py` - SQLAlchemy model
- `backend/app/schemas/spare_parts_request.py` - Pydantic schemas (Create, Update, Response, Approve, Reject)
- `backend/app/api/v1/endpoints/spare_parts_requests.py` - API endpoints

**Backend Files to Modify**:
- `backend/app/api/v1/api.py` - Register spare_parts_requests router
- `backend/app/models/maintenance_work.py` - Add relationship if not present
- `backend/app/models/spare_part.py` - Verify relationship exists

**Frontend Files to Create**:
- `frontend/src/lib/api/spare-parts-requests.ts` - API client functions
- `frontend/src/components/maintenance/SparePartsRequestForm.tsx` - Request creation form
- `frontend/src/components/maintenance/SparePartsRequestsList.tsx` - Requests list with filtering
- `frontend/src/components/maintenance/RequestApproval.tsx` - Approval/rejection UI for managers
- `frontend/src/components/maintenance/PartsIssuance.tsx` - Parts issuing UI for inventory managers

**Frontend Files to Modify**:
- `frontend/src/lib/types.ts` - Add SparePartsRequest, RequestStatus enum, and related types
- `frontend/src/app/(dashboard)/maintenance/work/[id]/page.tsx` - Add spare parts requests section
- `frontend/src/app/(dashboard)/maintenance/requests/page.tsx` - Add spare parts requests view if needed

### Technical Constraints

**Workflow State Management**:
- Request status must follow sequence: PENDING → (APPROVED | REJECTED) → ISSUED
- Cannot approve/reject a request that's already ISSUED
- Cannot issue a request that's not APPROVED
- Maintenance request status should update to WAITING_PARTS when parts are requested

**Stock Validation**:
- When issuing parts, validate sufficient stock exists: `sparePart.quantity >= quantityRequested`
- Return appropriate error if stock is insufficient
- Display current stock in UI before allowing request creation

**Database Transactions**:
- Issue action must be atomic: Update request status + Create inventory transaction + Update spare part quantity + Create activity log
- Use SQLAlchemy session transactions to ensure consistency
- Rollback on any failure

**Integration with Existing Systems**:
- Leverage existing InventoryTransaction system from Story 4.2
- Use existing ActivityLog system for audit trail
- Integrate with MaintenanceWork and MaintenanceRequest models

### Project Structure Notes

All file locations align with the unified project structure defined in `docs/architecture.md#1057-1230`. Components follow the existing pattern from Story 4.2 for consistency.


## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-01-27 | 1.1 | Complete implementation of spare parts request and approval workflow | James (Dev Agent) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

- No linting errors found in backend or frontend
- All API endpoints registered and functional
- Components follow existing patterns from Story 4.2

### Completion Notes List

1. **Backend Implementation:**
   - Created SparePartsRequest model with status enum (PENDING, APPROVED, REJECTED, ISSUED)
   - Added relationships to MaintenanceWork, SparePart, and User models
   - Implemented all API endpoints with proper authorization and validation
   - Integrated with InventoryTransaction system for automatic stock deduction
   - Added activity logging for all workflow actions
   - Maintenance request status automatically updates to WAITING_PARTS when parts are requested

2. **Frontend Implementation:**
   - Created API client with full CRUD operations
   - Implemented SparePartsRequestForm with manual save button pattern
   - Created SparePartsRequestsList with status filtering
   - Built RequestApproval and PartsIssuance components for managers
   - Integrated into RequestDetailModal for maintenance work
   - Added stock warnings and current stock display

3. **Key Features:**
   - Technicians can request parts during maintenance work
   - Maintenance managers can approve/reject requests
   - Inventory managers can issue approved parts
   - Automatic inventory transaction creation and stock deduction
   - Complete activity logging for audit trail
   - Real-time updates with React Query

4. **Database Migration:**
   - Created and applied Alembic migration: `a1b2c3d4e5f6` - `create_spare_parts_requests_table`
   - Migration creates spare_parts_requests table with all foreign keys, indexes, and enum types
   - Table successfully created in database

### File List

**Backend Files Created:**
- `backend/app/models/spare_parts_request.py`
- `backend/app/schemas/spare_parts_request.py`
- `backend/app/api/v1/endpoints/spare_parts_requests.py`
- `backend/alembic/versions/create_spare_parts_requests_table.py` - Database migration

**Backend Files Modified:**
- `backend/app/models/__init__.py` - Added SparePartsRequest import
- `backend/app/models/user.py` - Added sparePartsRequests relationships
- `backend/app/models/maintenance_work.py` - Added sparePartsRequests relationship
- `backend/app/models/spare_part.py` - Added sparePartsRequests relationship
- `backend/app/api/v1/api.py` - Registered spare_parts_requests router

**Frontend Files Created:**
- `frontend/src/lib/api/spare-parts-requests.ts`
- `frontend/src/components/maintenance/SparePartsRequestForm.tsx`
- `frontend/src/components/maintenance/SparePartsRequestsList.tsx`
- `frontend/src/components/maintenance/RequestApproval.tsx`
- `frontend/src/components/maintenance/PartsIssuance.tsx`

**Frontend Files Modified:**
- `frontend/src/lib/types.ts` - Added SparePartsRequest types
- `frontend/src/components/maintenance/RequestDetailModal.tsx` - Added spare parts requests section

## QA Results

_This section will be populated by the QA agent after implementation review_

